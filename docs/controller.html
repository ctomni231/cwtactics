<!DOCTYPE html>

<html>
<head>
  <title>controller.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="doc.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ai.html">
                  ai.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="controller.html">
                  controller.js
                </a>
              
                
                <a class="source" href="datatypes.html">
                  datatypes.js
                </a>
              
                
                <a class="source" href="dependencies.html">
                  dependencies.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="input.html">
                  input.js
                </a>
              
                
                <a class="source" href="loading.html">
                  loading.js
                </a>
              
                
                <a class="source" href="logic.html">
                  logic.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="modification.html">
                  modification.js
                </a>
              
                
                <a class="source" href="renderer.html">
                  renderer.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>controller.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-comment">/**
 *
 * @class
 */</span>
cwt.ActionData = my.Class({

  STATIC: {

    <span class="hljs-comment">/**
     * Converts an action data object to JSON.
     *
     * @param {cwt.ActionData} data
     * @return {string}
     */</span>
    toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify([data.id, data.p1, data.p2, data.p3, data.p4, data.p5]);
    },

    <span class="hljs-comment">/**
     * Converts a JSON string to an action data object.
     *
     * @param {cwt.ActionData} data
     */</span>
    fromJSON: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>  data === <span class="hljs-string">"string"</span>) {
        data = <span class="hljs-built_in">JSON</span>.stringify(data)
      }

      <span class="hljs-keyword">this</span>.id = data[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">this</span>.p1 = data[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">this</span>.p2 = data[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">this</span>.p3 = data[<span class="hljs-number">3</span>];
      <span class="hljs-keyword">this</span>.p4 = data[<span class="hljs-number">4</span>];
      <span class="hljs-keyword">this</span>.p5 = data[<span class="hljs-number">5</span>];
    }
  },

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.reset();
  },

  <span class="hljs-comment">/**
   *
   */</span>
  reset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.id = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.p1 = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.p2 = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.p3 = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.p4 = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.p5 = -<span class="hljs-number">1</span>;
  },

  toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ActionData::[id:"</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">" ("</span> +
      (cwt.Action.classNames_[<span class="hljs-keyword">this</span>.id]) +
      <span class="hljs-string">") p1:"</span> + <span class="hljs-keyword">this</span>.p1 + <span class="hljs-string">" p2:"</span> + <span class="hljs-keyword">this</span>.p2 + <span class="hljs-string">" p3:"</span> + <span class="hljs-keyword">this</span>.p3 + <span class="hljs-string">" p4:"</span> + <span class="hljs-keyword">this</span>.p4 + <span class="hljs-string">" p5:"</span> + <span class="hljs-keyword">this</span>.p5 + <span class="hljs-string">"]"</span>;
  }
});

<span class="hljs-comment">/**
 * Action stack of Custom Wars: Tactics.
 *
 * @namespace
 */</span>
cwt.ActionStack = {

  <span class="hljs-comment">/**
   * Pool for holding {cwt.ActionData} objects when they aren't in the buffer.
   *
   * @type {cwt.CircularBuffer.&lt;cwt.ActionData&gt;}
   */</span>
  actionDataPool: <span class="hljs-keyword">new</span> cwt.CircularBuffer(<span class="hljs-number">200</span>),

  <span class="hljs-comment">/**
   * Buffer object.
   *
   * @type {cwt.CircularBuffer.&lt;cwt.ActionData&gt;}
   */</span>
  buffer: <span class="hljs-keyword">new</span> cwt.CircularBuffer(<span class="hljs-number">200</span>),

  $afterLoad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">while</span> (!<span class="hljs-keyword">this</span>.actionDataPool.isFull()) {
      <span class="hljs-keyword">this</span>.actionDataPool.push(<span class="hljs-keyword">new</span> cwt.ActionData());
    }
  },

  <span class="hljs-comment">/**
   * Resets the buffer object.
   */</span>
  resetData: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.hasData()) {
      <span class="hljs-keyword">this</span>.actionDataPool.push(<span class="hljs-keyword">this</span>.buffer.pop());
    }
  },

  <span class="hljs-comment">/**
   * Returns true when the buffer has elements else false.
   */</span>
  hasData: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.buffer.isEmpty();
  },

  <span class="hljs-comment">/**
   *
   */</span>
  invokeNext: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.buffer.popFirst();

    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(data);
    <span class="hljs-keyword">if</span> (cwt.DEBUG) console.log(data);

    <span class="hljs-keyword">var</span> action = cwt.Action.getInstanceById(data.id);
    action.parseDataBlock(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pool used object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    data.reset();
    <span class="hljs-keyword">this</span>.actionDataPool.push(data);
  },

  acquireCommand: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.actionDataPool.popFirst();
  },

  <span class="hljs-comment">/**
   * Adds a command to the command pool. Every parameter of the call will be submitted beginning from index 1 of the
   * arguments. The maximum amount of parameters are controlled by the controller.commandStack_MAX_PARAMETERS property.
   * Anyway every parameter should be an integer to support intelligent JIT compiling. The function throws a warning if
   * a parameter type does not match, but it will be accepted anyway ** ( for now! ) **.
   *
   * @param {boolean} local will the command only invoked locally
   * @param {cwt.ActionData} data
   */</span> 
  pushCommand: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(local, data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>send command over network</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!local &amp;&amp; cwt.Network.isActive()) {
      cwt.Network.sendMessage(cwt.ActionData.toJSON(data));
    }

    <span class="hljs-keyword">this</span>.buffer.push(data);
  }
};

cwt.Audio = {

  <span class="hljs-comment">/**
   * Storage parameter for sfx volume.
   *
   * @constant
   */</span>
  SFX_VOLUME_KEY: <span class="hljs-string">"cfg_sfx_volume"</span>,

  <span class="hljs-comment">/**
   * Storage parameter for music volume.
   *
   * @constant
   */</span>
  MUSIC_VOLUME_KEY: <span class="hljs-string">"cfg_music_volume"</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  SFX_KEY: <span class="hljs-string">"SFX_"</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  MUSIC_KEY: <span class="hljs-string">"MUSIC_"</span>,

  <span class="hljs-comment">/**
   * WebAudio context object.
   *
   * @private
   */</span>
  context_: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Music audio node.
   *
   * @private
   */</span>
  gainNode_music_: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * SFX audio node.
   *
   * @private
   */</span>
  gainNode_sfx_: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Cache for audio buffers.
   *
   * @private
   */</span>
  buffer_: {},

  <span class="hljs-comment">/**
   * Current played music object.
   *
   * @private
   */</span>
  currentMusic_: {
    inLoadProcess: <span class="hljs-literal">false</span>,
    connector: <span class="hljs-literal">null</span>,
    id: <span class="hljs-literal">null</span>
  },

  <span class="hljs-comment">/**
   * Initializes the audio context.
   */</span>
  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if audio sfx and music is deactivated then do not initialize the audio context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.ClientFeatures.audioSFX || cwt.ClientFeatures.audioMusic) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>construct new context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (window.AudioContext) {
        <span class="hljs-keyword">this</span>.context_ = <span class="hljs-keyword">new</span> window.AudioContext();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (window.webkitAudioContext) {
        <span class="hljs-keyword">this</span>.context_ = <span class="hljs-keyword">new</span> window.webkitAudioContext();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>construct audio nodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.context_) {
        <span class="hljs-keyword">this</span>.gainNode_sfx_ = <span class="hljs-keyword">this</span>.context_.createGainNode();
        <span class="hljs-keyword">this</span>.gainNode_sfx_.gain.value = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">this</span>.gainNode_sfx_.connect(<span class="hljs-keyword">this</span>.context_.destination);
        <span class="hljs-keyword">this</span>.gainNode_music_ = <span class="hljs-keyword">this</span>.context_.createGainNode();
        <span class="hljs-keyword">this</span>.gainNode_music_.gain.value = <span class="hljs-number">0.5</span>;
        <span class="hljs-keyword">this</span>.gainNode_music_.connect(<span class="hljs-keyword">this</span>.context_.destination);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>remove initializer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.Audio.initialize = <span class="hljs-literal">null</span>;
    }
  },

  <span class="hljs-comment">/**
   * Returns a web audio context. If no context is initialized then it will be created first.
   */</span>
  grabContext: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context_;
  },

  <span class="hljs-comment">/**
   * Returns the value of the sfx audio node.
   */</span>
  getSfxVolume: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.gainNode_sfx_.gain.value;
  },

  <span class="hljs-comment">/**
   * Returns the value of the music audio node.
   */</span>
  getMusicVolume: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.gainNode_music_.gain.value;
  },

  <span class="hljs-comment">/**
   * Sets the value of the sfx audio node.
   */</span>
  setSfxVolume: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(vol)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (vol &lt; <span class="hljs-number">0</span>) {
      vol = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vol &gt; <span class="hljs-number">1</span>) {
      vol = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">this</span>.gainNode_sfx_.gain.value = vol;
  },

  <span class="hljs-comment">/**
   * Sets the value of the music audio node.
   */</span>
  setMusicVolume: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(vol)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (vol &lt; <span class="hljs-number">0</span>) {
      vol = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vol &gt; <span class="hljs-number">1</span>) {
      vol = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">this</span>.gainNode_music_.gain.value = vol;
  },

  <span class="hljs-comment">/**
   * Saves the configurations for the audio volume in the user storage.
   *
   * @param {Function=} callback Callback function
   */</span>
  saveConfigs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) {
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>sfx volume</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Storage.generalStorage.set(
      cwt.Audio.SFX_VOLUME_KEY,
      cwt.Audio.gainNode_sfx_.gain.value,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>music volume</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        cwt.Storage.generalStorage.set(
          cwt.Audio.MUSIC_VOLUME_KEY,
          cwt.Audio.gainNode_music_.gain.value,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (callback) {
              callback();
            }
          }
        );
      }
    );
  },

  <span class="hljs-comment">/**
   * Loads the volume configuration from the user storage.
   *
   * @param {Function=} callback Callback function
   */</span>
  loadConfigs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) {
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>sfx config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Storage.generalStorage.get(cwt.Audio.SFX_VOLUME_KEY, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
      <span class="hljs-keyword">if</span> (obj) {
        cwt.Audio.gainNode_sfx_.gain.value = obj.value;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>music config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.Storage.generalStorage.get(cwt.Audio.MUSIC_VOLUME_KEY, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
        <span class="hljs-keyword">if</span> (obj) {
          cwt.Audio.gainNode_music_.gain.value = obj.value;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>callback if given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (callback) {
          callback();
        }
      });
    });
  },

  <span class="hljs-comment">/**
   * Registers an audio buffer object.
   *
   * @param id
   * @param buff
   */</span>
  registerAudioBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, buff)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(!<span class="hljs-keyword">this</span>.isBuffered(id));

    <span class="hljs-keyword">this</span>.buffer_[id] = buff;
  },

  <span class="hljs-comment">/**
   * Removes a buffer from the cache.
   */</span>
  unloadBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isBuffered(id));

    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.buffer_[id];
  },

  <span class="hljs-comment">/**
   *
   * @param id
   * @return {boolean}
   */</span>
  isBuffered: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.buffer_.hasOwnProperty(id);
  },

  <span class="hljs-comment">/**
   * Plays an empty sound buffer. Useful to
   * initialize the audio system.
   */</span>
  playNullSound: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">this</span>.context_.createBuffer(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22050</span>);
    <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">this</span>.context_.createBufferSource();

    source.buffer = buffer;
    source.connect(<span class="hljs-keyword">this</span>.context_.destination);
    source.noteOn(<span class="hljs-number">0</span>);
  },

  playSoundOnNode_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(gainNode, buffer, loop)</span> {</span>
    <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">this</span>.context_.createBufferSource();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>is loop enabled ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (loop) {
      source.loop = <span class="hljs-literal">true</span>;
    }

    source.buffer = buffer;
    source.connect(gainNode);
    source.noteOn(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> source;
  },

  <span class="hljs-comment">/**
   * Plays a sound.
   *
   * @param {string} id id of the sound that will be played
   * @param {boolean=} loop (default:false)
   * @return {*}
   */</span>
  playSound: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, loop)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.buffer_[id]);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.playSoundOnNode_(<span class="hljs-keyword">this</span>.gainNode_sfx_, <span class="hljs-keyword">this</span>.buffer_[id], loop);
  },

  <span class="hljs-comment">/**
   *
   * @param obj
   * @private
   */</span>
  musicLoaderCallback_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(obj.value);

    <span class="hljs-keyword">this</span>.currentMusic_.connector = <span class="hljs-keyword">this</span>.playSoundOnNode_(
      <span class="hljs-keyword">this</span>.gainNode_music_,
      Base64Helper.decodeBuffer(obj.value),
      <span class="hljs-literal">true</span>
    );</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>release loading lock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.currentMusic_.inLoadProcess = <span class="hljs-literal">false</span>;
  },

  <span class="hljs-comment">/**
   * Plays a background music.
   *
   * @param id id of the music object
   */</span>
  playMusic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_ || <span class="hljs-keyword">this</span>.currentMusic_.inLoadProcess) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>already playing this music ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentMusic_.id === id) {
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>stop old music</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentMusic_.connector) {
      <span class="hljs-keyword">this</span>.stopMusic();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>set meta data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.currentMusic_.inLoadProcess = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.currentMusic_.id = id;
    cwt.Storage.generalStorage.get(<span class="hljs-keyword">this</span>.MUSIC_KEY + id, <span class="hljs-keyword">this</span>.musicLoaderCallback_);

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   * Stop existing background music.
   */</span>
  stopMusic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_ || <span class="hljs-keyword">this</span>.currentMusic_.inLoadProcess) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>disable current music</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentMusic_) {
      <span class="hljs-keyword">this</span>.currentMusic_.connector.noteOff(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">this</span>.currentMusic_.connector.disconnect(<span class="hljs-number">0</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>remove meta data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.currentMusic_.connector = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.currentMusic_.id = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.currentMusic_.inLoadProcess = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   *
   * @private
   */</span>
  removeGrabbers_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">delete</span> cwt.Audio.removeGrabbers_;
    <span class="hljs-keyword">delete</span> cwt.Audio.grabFromCache;
    <span class="hljs-keyword">delete</span> cwt.Audio.grabFromRemote;
  },

  <span class="hljs-comment">/**
   *
   * @param {Function} callback
   */</span>
  grabFromCache: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.removeGrabbers_(); <span class="hljs-comment">// remove initializer functions</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) { <span class="hljs-comment">// don't load audio when disabled</span>
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadKey</span><span class="hljs-params">(key)</span> {</span>
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        cwt.Storage.assetsStorage.get(key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
          <span class="hljs-keyword">if</span> (cwt.DEBUG) {
            console.log(<span class="hljs-string">"grab audio "</span>+key+<span class="hljs-string">" from cache"</span>);
          }

          <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(obj.value);

          <span class="hljs-keyword">var</span> realKey = obj.key.slice(cwt.Audio.SFX_KEY.length);
          <span class="hljs-keyword">var</span> arrayBuffer = Base64Helper.decodeBuffer(obj.value);
          cwt.Audio.context_.decodeAudioData( arrayBuffer,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>success handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(buffer)</span> {</span>
              cwt.Audio.registerAudioBuffer(realKey,buffer);
              <span class="hljs-keyword">if</span>( next ) next(<span class="hljs-literal">true</span>);
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>error handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( e )</span>{</span>
              <span class="hljs-keyword">if</span>( next ) next(<span class="hljs-literal">false</span>);
            }
          );
        });
      });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>load all possible audio (except music) keys from the storage into the RAM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Storage.assetsStorage.keys(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keys)</span> {</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = keys.length; i &lt; e; i++) {
        <span class="hljs-keyword">var</span> key = keys[i];
        <span class="hljs-keyword">if</span> (key.indexOf(cwt.Audio.SFX_KEY) === <span class="hljs-number">0</span>) {
          loadKey(key);
        }
      }

      callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span>{</span>
        <span class="hljs-keyword">delete</span> cwt.Sounds;
        <span class="hljs-keyword">delete</span> cwt.Musics;
        callback();
      });
    });
  },

  <span class="hljs-comment">/**
   *
   * @param {Function} callback
   */</span>
  grabFromRemote: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.removeGrabbers_(); <span class="hljs-comment">// remove initializer functions</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context_) {<span class="hljs-comment">// don't load audio when disabled</span>
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-comment">/**
     *
     * @inner
     * @param id
     * @param audioData
     * @param callback
     */</span>
    <span class="hljs-keyword">var</span> loadBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, audioData, callback)</span> {</span>
      cwt.Audio.context_.decodeAudioData(</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>buffer data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        audioData,</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>success handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(buffer)</span> {</span>
          cwt.Audio.registerAudioBuffer(id, buffer);
          <span class="hljs-keyword">if</span> (callback) {
            callback();
          }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>error handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
          cwt.Error(e, <span class="hljs-string">"ERR_AUDIO_BUFFER_LOAD"</span>);
        }
      );
    };

    <span class="hljs-comment">/**
     *
     * @inner
     * @param key
     * @param path
     * @param saveKey
     * @param loadIt
     * @param callback
     */</span>
    <span class="hljs-keyword">var</span> loadFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, path, saveKey, loadIt, callback)</span> {</span>
      <span class="hljs-keyword">if</span> (cwt.DEBUG) {
        console.log(<span class="hljs-string">"going to load "</span>+path+<span class="hljs-string">" for key "</span>+key);
      }

      <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();

      request.open(<span class="hljs-string">"GET"</span>, cwt.MOD_PATH+path, <span class="hljs-literal">true</span>);
      request.responseType = <span class="hljs-string">"arraybuffer"</span>;

      request.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        cwt.assert(<span class="hljs-keyword">this</span>.status !== <span class="hljs-number">404</span>);

        <span class="hljs-keyword">if</span> (cwt.DEBUG) {
          console.log(<span class="hljs-string">"load "</span>+path+<span class="hljs-string">" for key "</span>+key+<span class="hljs-string">" sucessfully"</span>);
        }

        cwt.Storage.assetsStorage.set(saveKey,
          Base64Helper.encodeBuffer(request.response),
          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (loadIt) {
              loadBuffer(key, request.response, callback);
            } <span class="hljs-keyword">else</span> {
              callback();
            }
          }
        );
      };

      request.send();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>only load music when supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.ClientFeatures.audioMusic) {
      <span class="hljs-built_in">Object</span>.keys(cwt.Musics).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
        stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
          loadFile(key, cwt.Musics[key], cwt.Audio.MUSIC_KEY + key, <span class="hljs-literal">false</span>, next);
        })
      });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>only load sfx audio when supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.ClientFeatures.audioSFX) {
      <span class="hljs-built_in">Object</span>.keys(cwt.Sounds).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
        stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
          loadFile(key, cwt.Sounds[key], cwt.Audio.SFX_KEY + key, <span class="hljs-literal">true</span>, next);
        })
      });
    }

    callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">delete</span> cwt.Sounds;
      <span class="hljs-keyword">delete</span> cwt.Musics;
      callback();
    });
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Cursor = {

  <span class="hljs-comment">/**
   * X coordinate of the cursor.
   */</span>
  x: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   * Y coordinate of the cursor.
   */</span>
  y: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   *
   */</span>
  reset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.x = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.y = <span class="hljs-number">0</span>;
  },

  <span class="hljs-comment">/**
   * Moves the cursor into a given direction.
   *
   * @param {number} dir
   */</span>
  move: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dir)</span> {</span>
    <span class="hljs-keyword">var</span> len = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> x = <span class="hljs-keyword">this</span>.x;
    <span class="hljs-keyword">var</span> y = <span class="hljs-keyword">this</span>.y;

    <span class="hljs-keyword">switch</span> (dir) {

      <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_UP :
        y -= len;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_RIGHT :
        x += len;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_DOWN  :
        y += len;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_LEFT  :
        x -= len;
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">this</span>.setPosition(x, y);
  },

  <span class="hljs-comment">/**
   * Moves the cursor to a given position. The view will be moved as well with
   * this function to make sure that the cursor is on the visible view.
   */</span>
  setPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, relativeToScreen)</span> {</span>
    <span class="hljs-keyword">if</span> (relativeToScreen) {
      x = x + cwt.Screen.offsetX;
      y = y + cwt.Screen.offsetY;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>change illegal positions to prevent out of bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) x = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-number">0</span>) y = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (x &gt;= cwt.Map.width) x = cwt.Map.width - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (y &gt;= cwt.Map.height) y = cwt.Map.height - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (x === <span class="hljs-keyword">this</span>.x &amp;&amp; y === <span class="hljs-keyword">this</span>.y) {
      <span class="hljs-keyword">return</span>;
    }

    cwt.MapRenderer.eraseCursor();

    <span class="hljs-keyword">this</span>.x = x;
    <span class="hljs-keyword">this</span>.y = y;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>convert to screen relative pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    x = x - cwt.Screen.offsetX;
    y = y - cwt.Screen.offsetY;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> moveCode = cwt.INACTIVE;
    <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">3</span>) {
      moveCode = cwt.Move.MOVE_CODES_RIGHT;
      <span class="hljs-keyword">if</span> (cwt.Screen.shiftScreen(moveCode)) {
        cwt.MapRenderer.shiftMap(moveCode,cwt.Gameflow.globalData.selection);
      }

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (x &gt;= cwt.SCREEN_WIDTH - <span class="hljs-number">3</span>) {
      moveCode = cwt.Move.MOVE_CODES_LEFT;
      <span class="hljs-keyword">if</span> (cwt.Screen.shiftScreen(moveCode)) {
        cwt.MapRenderer.shiftMap(moveCode,cwt.Gameflow.globalData.selection);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (y &lt;= <span class="hljs-number">3</span>) {
      moveCode = cwt.Move.MOVE_CODES_DOWN;
      <span class="hljs-keyword">if</span> (cwt.Screen.shiftScreen(moveCode)) {
        cwt.MapRenderer.shiftMap(moveCode,cwt.Gameflow.globalData.selection);
      }

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (y &gt;= cwt.SCREEN_HEIGHT - <span class="hljs-number">3</span>) {
      moveCode = cwt.Move.MOVE_CODES_UP;
      <span class="hljs-keyword">if</span> (cwt.Screen.shiftScreen(moveCode)) {
        cwt.MapRenderer.shiftMap(moveCode,cwt.Gameflow.globalData.selection);
      }
    }

    cwt.MapRenderer.renderCursor();
  },

  showNativeCursor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    cwt.Screen.layerUI.getLayer().style.cursor = <span class="hljs-string">""</span>;
  },

  hideNativeCursor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    cwt.Screen.layerUI.getLayer().style.cursor = <span class="hljs-string">"none"</span>;
  }

};

cwt.Error = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message,where)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>set state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cwt.Gameflow.changeState(<span class="hljs-string">"ERROR_SCREEN"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>set meta data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> state = cwt.Gameflow.activeState;
  state.data.message = message;
  state.data.where = where;
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.ClientEvents = {

  animCmd_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> {</span>
    <span class="hljs-keyword">var</span> cmd = cwt.ActionStack.acquireCommand();
    cmd.key = cwt.Action.getInstanceId(cwt.Action.getInstanceKey(<span class="hljs-string">"startAnimation"</span>));
    cmd.p1 = state;

    cwt.ActionStack.pushCommand(<span class="hljs-literal">false</span>, cmd);
  },

  <span class="hljs-comment">/**
   */</span>
  turnChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> x = cwt.Screen.offsetX;
    <span class="hljs-keyword">var</span> y = cwt.Screen.offsetY;
    <span class="hljs-keyword">var</span> w = (cwt.Map.width &lt; cwt.SCREEN_WIDTH) ? cwt.Map.width : cwt.SCREEN_WIDTH;
    <span class="hljs-keyword">var</span> h = (cwt.Map.height &lt; cwt.SCREEN_HEIGHT) ? cwt.Map.height : cwt.SCREEN_HEIGHT;

    cwt.Screen.layerUnit.clearAll();

    cwt.MapRenderer.renderUnits(x, y, w, h);
    cwt.MapRenderer.renderFogRect(x, y, w, h);

    cwt.Screen.layerUnit.renderLayer(cwt.MapRenderer.indexUnitAnimation);

    <span class="hljs-keyword">this</span>.animCmd_(<span class="hljs-number">0</span>);
  },

  <span class="hljs-comment">/**
   *
   * @param {number} sx
   * @param {number} sy
   * @param {number} tx
   * @param {number} ty
   * @param {cwt.Array} way
   * @param {boolean} trapped
   */</span>
  unitMoves: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sx, sy, tx, ty, way, trapped)</span> {</span>

  },

  unitWaits: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

  },

  goldChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, money)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Play a money down animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },

  unitCreated: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, unit)</span> {</span>

  },

  unitDestroyed: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, unit)</span> {</span>

  },

  unitCaptures: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, capturer)</span> {</span>

  },

  propertyCaptured: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, capturer)</span> {</span>

  },

  propertyTypeChanged: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, typeOld, typeNew)</span> {</span>

  }

};

<span class="hljs-comment">/**
 * Contains all features of the web client.
 * If the value of a feature is `true`, then it will
 * be supported by the current active environment.
 * If the value is `false`, then it isn't supported.
 *
 * @type {Object}
 */</span>
cwt.ClientFeatures = {

  <span class="hljs-comment">/**
   * Controls the availability of audio effects.
   */</span>
  audioSFX: ((Browser.chrome || Browser.safari || (Browser.ios &amp;&amp; Browser.version &gt;= <span class="hljs-number">6</span>)) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Controls the availability of music.
   */</span>
  audioMusic: ((Browser.chrome || Browser.safari) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Controls the availability of game-pad input.
   */</span>
  gamePad: ((Browser.chrome &amp;&amp; !!navigator.webkitGetGamepads) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Controls the availability of computer keyboard input.
   */</span>
  keyboard:	((!Browser.mobile) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Controls the availability of mouse input.
   */</span>
  mouse: ((!Browser.mobile) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Controls the availability of touch input.
   */</span>
  touch: ((Browser.mobile) === <span class="hljs-literal">true</span>),

  <span class="hljs-comment">/**
   * Signals a official supported environment. If false then it doesn't mean the
   * environment cannot run the game, but the status is not official tested. As
   * result the game could run fine or breaks.
   */</span>
  supported: ((Browser.chrome || Browser.safari || Browser.ios || Browser.android) === <span class="hljs-literal">true</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>scaledImg:  false,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-comment">/**
   * Controls the usage of the workaround for the iOS7 WebSQL DB bug.
   */</span>
  iosWebSQLFix: ((Browser.ios &amp;&amp; Browser.version &gt;= <span class="hljs-number">7</span>) === <span class="hljs-literal">true</span>)
};

<span class="hljs-comment">/**
 *
 * @type {{}}
 */</span>
cwt.FlowData = {

  <span class="hljs-comment">/**
   * Holds some information about the current action menu.
   *
   * @namespace
   */</span>
  menu: {

    <span class="hljs-comment">/**
     * Adds unload targets for a transporter at a given position to the menu.
     *
     * @param uid
     * @param x
     * @param y
     * @param menu
     */</span>
    addUnloadTargetsToMenu: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(uid, x, y, menu)</span> {</span>
      <span class="hljs-keyword">var</span> loader = model.unit_data[uid];
      <span class="hljs-keyword">var</span> pid = loader.owner;
      <span class="hljs-keyword">var</span> i = model.unit_firstUnitId(pid);
      <span class="hljs-keyword">var</span> e = model.unit_lastUnitId(pid);
      <span class="hljs-keyword">var</span> unit;

      <span class="hljs-keyword">for</span> (; i &lt;= e; i++) {
        unit = model.unit_data[i];

        <span class="hljs-keyword">if</span> (unit.owner !== cwt.INACTIVE &amp;&amp; unit.loadedIn === uid) {
          <span class="hljs-keyword">var</span> movetp = model.data_movetypeSheets[ unit.type.movetype ];

          <span class="hljs-keyword">if</span> (model.move_canTypeMoveTo(movetp, x - <span class="hljs-number">1</span>, y) ||
            model.move_canTypeMoveTo(movetp, x + <span class="hljs-number">1</span>, y) ||
            model.move_canTypeMoveTo(movetp, x, y - <span class="hljs-number">1</span>) ||
            model.move_canTypeMoveTo(movetp, x, y + <span class="hljs-number">1</span>)) menu.addEntry(i, <span class="hljs-literal">true</span>);
        }
      }
    }
  },

  selection: (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-comment">/*
    var sMap = new cwt.SelectionMap(cwt.MAX_MOVE_LENGTH * 4 + 1);

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Extension to the selection map. This one prepares the selection
for the current aw2 model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sMap.prepare = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> target = controller.stateMachine.data.target;
      <span class="hljs-keyword">var</span> x = target.x;
      <span class="hljs-keyword">var</span> y = target.y;

      <span class="hljs-keyword">this</span>.setCenter(x, y, -<span class="hljs-number">1</span>);

      <span class="hljs-keyword">var</span> actObj = controller.stateMachine.data.action.object;
      actObj.prepareTargets(controller.stateMachine.data);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>decide which selection mode will be used based on the given action object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> (actObj.targetSelectionType === <span class="hljs-string">"A"</span>) ? <span class="hljs-string">"ACTION_SELECT_TARGET_A"</span> :
        <span class="hljs-string">"ACTION_SELECT_TARGET_B"</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    sMap.rerenderNonInactive = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> e = <span class="hljs-keyword">this</span>.data.length;
      <span class="hljs-keyword">var</span> cx = <span class="hljs-keyword">this</span>.centerX;
      <span class="hljs-keyword">var</span> cy = <span class="hljs-keyword">this</span>.centerY;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>rerender aw2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      for (var x = 0; x &lt; e; x++) {
        for (var y = 0; y &lt; e; y++) {
          if (this.data[x + cx][y + cy] &gt; cwt.INACTIVE) view.redraw_markPos(x + cx, y + cy);
        }
      }
    };

    return sMap;
    */
  })(),

  addUnloadTargetsToSelection: function (uid, x, y, loadId, selection) {
    var loader = model.unit_data[uid];
    var movetp = model.data_movetypeSheets[ model.unit_data[ loadId ].type.movetype ];

    if (model.move_canTypeMoveTo(movetp, x - 1, y)) selection.setValueAt(x - 1, y, 1);
    if (model.move_canTypeMoveTo(movetp, x + 1, y)) selection.setValueAt(x + 1, y, 1);
    if (model.move_canTypeMoveTo(movetp, x, y - 1)) selection.setValueAt(x, y - 1, 1);
    if (model.move_canTypeMoveTo(movetp, x, y + 1)) selection.setValueAt(x, y + 1, 1);
  },

  selectionRange: cwt.INACTIVE

};

/**
 * @namespace
 */
cwt.GameData = {

  /**
   *
   */
  saveGame: (function () {
    var caller = cwt.createModuleCaller("$onSaveGame");
    return function (name, callback) {
      var dom = {};
      caller(dom);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>save object model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.Storage.mapStorage.set(name, <span class="hljs-built_in">JSON</span>.stringify(dom), callback);
    };
  })(),

  <span class="hljs-comment">/**
   * Sets the game model to a state that represents the given save game object.
   *
   * @param name
   * @param isSave
   * @param callback
   */</span>
  loadGame: (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> caller = cwt.createModuleCaller(<span class="hljs-string">"$onLoadGame"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, isSave, callback)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">"string"</span>) {
        cwt.Storage.mapStorage.get(name, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
          cwt.assert(obj.value);
          caller(<span class="hljs-built_in">JSON</span>.parse(obj.value), isSave);
          callback();
        });
      } <span class="hljs-keyword">else</span> {
        caller(name, isSave);
        callback();
      }
    };
  })()

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Gameflow = {

  <span class="hljs-comment">/**
   * @type {String}
   */</span>
  activeStateId: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * @type {cwt.GameState}
   */</span>
  activeState: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * @type {Array.&lt;cwt.GameState&gt;}
   * @private
   */</span>
  states_: {},

  <span class="hljs-comment">/**
   * State-Machine data object to share data between
   * states.
   */</span>
  globalData: {},

  <span class="hljs-comment">/**
   *
   * @param desc
   */</span>
  addState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(desc)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(!<span class="hljs-keyword">this</span>.states_.hasOwnProperty(desc.id));

    <span class="hljs-keyword">var</span> state = <span class="hljs-keyword">new</span> cwt.GameState(
      desc.enter ? desc.enter : cwt.emptyFunction,
      desc.exit ? desc.exit : cwt.emptyFunction,
      desc.update ? desc.update : cwt.emptyFunction,
      desc.render ? desc.render : cwt.emptyFunction,
      {
        globalData: <span class="hljs-keyword">this</span>.globalData
      }
    );

    <span class="hljs-keyword">if</span> (desc.init) {
      desc.init.call(state.data, state.data.globalData);
    }

    <span class="hljs-keyword">this</span>.states_[desc.id] = state;
  },

  <span class="hljs-comment">/**
   *
   * @param desc
   */</span>
  addInGameState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(desc)</span> {</span>
    cwt.Gameflow.addState({

      id: desc.id,

      init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>.inputMove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
          <span class="hljs-keyword">if</span> (desc.inputMove) {
            desc.inputMove.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, x, y);
          } <span class="hljs-keyword">else</span> {
            cwt.Cursor.setPosition(
              cwt.Screen.convertToTilePos(x),
              cwt.Screen.convertToTilePos(y),
              <span class="hljs-literal">true</span>
            );
          }
        };

        <span class="hljs-keyword">if</span> (desc.init) {
          desc.init.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData);
        }
      },

      enter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (desc.enter) {
          desc.enter.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData);
        }
      },

      exit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (desc.exit) {
          desc.exit.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData);
        }
      },

      update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta, input)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>check stack for buffered commands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (cwt.ActionStack.hasData()) {
          cwt.ActionStack.invokeNext();
          <span class="hljs-keyword">return</span>;
        }

        cwt.Gameround.gameTimeElapsed += delta;
        cwt.Gameround.turnTimeElapsed += delta;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>check_ turn time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (cwt.Gameround.turnTimeLimit &gt; <span class="hljs-number">0</span> &amp;&amp; cwt.Gameround.turnTimeElapsed &gt;= cwt.Gameround.turnTimeLimit) {
          <span class="hljs-keyword">var</span> dataBlock = cwt.ActionStack.acquireCommand();
          <span class="hljs-keyword">var</span> actionObject = cwt.Action.getActionObject(<span class="hljs-string">"wait"</span>);

          dataBlock.id = cwt.Action.getInstanceId(actionObject);
          actionObject.toDataBlock(<span class="hljs-literal">null</span>, dataBlock);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>check_ game time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (cwt.Gameround.gameTimeLimit &gt; <span class="hljs-number">0</span> &amp;&amp; cwt.Gameround.gameTimeElapsed &gt;= cwt.Gameround.gameTimeLimit) {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>TODO: controller.update_endGameRound();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }

        <span class="hljs-keyword">if</span> (input) {
          <span class="hljs-keyword">switch</span> (input.key) {

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_LEFT:
              <span class="hljs-keyword">if</span> (desc.LEFT) {
                desc.LEFT.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              } <span class="hljs-keyword">else</span> {
                cwt.Cursor.move(cwt.Move.MOVE_CODES_LEFT);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_UP:
              <span class="hljs-keyword">if</span> (desc.UP) {
                desc.UP.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              } <span class="hljs-keyword">else</span> {
                cwt.Cursor.move(cwt.Move.MOVE_CODES_UP);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_RIGHT:
              <span class="hljs-keyword">if</span> (desc.RIGHT) {
                desc.RIGHT.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              } <span class="hljs-keyword">else</span> {
                cwt.Cursor.move(cwt.Move.MOVE_CODES_RIGHT);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_DOWN:
              <span class="hljs-keyword">if</span> (desc.DOWN) {
                desc.DOWN.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              } <span class="hljs-keyword">else</span> {
                cwt.Cursor.move(cwt.Move.MOVE_CODES_DOWN);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_ACTION:
              <span class="hljs-keyword">if</span> (desc.ACTION) {
                desc.ACTION.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_CANCEL:
              <span class="hljs-keyword">if</span> (desc.CANCEL) {
                desc.CANCEL.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
              }
              <span class="hljs-keyword">break</span>;
          }
        }
      },

      render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta)</span> {</span>
        cwt.MapRenderer.evaluateCycle(delta, <span class="hljs-keyword">this</span>.globalData.focusActive);

        <span class="hljs-keyword">if</span> (desc.render) {
          desc.render.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.globalData, delta);
        }
      }

    });
  },

  <span class="hljs-comment">/**
   *
   * @param desc
   */</span>
  addMenuState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(desc)</span> {</span>
    cwt.Gameflow.addState({
      id: desc.id,

      init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>.layout = <span class="hljs-keyword">new</span> cwt.UIScreenLayout();
        <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">this</span>.inputMove = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.layout.updateIndex(x, y)) {
            <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">false</span>;
          }
        };

        <span class="hljs-keyword">if</span> (desc.init) {
          desc.init.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.layout);
        }

        <span class="hljs-keyword">if</span> (desc.doLayout) {
          desc.doLayout.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.layout);
        }

        <span class="hljs-keyword">if</span> (desc.genericInput) {
          <span class="hljs-keyword">this</span>.genericInput = desc.genericInput;
        }
      },

      enter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        cwt.Screen.layerUI.clear();
        <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (desc.enter) {
          desc.enter.call(<span class="hljs-keyword">this</span>);
        }
      },

      update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta, lastInput)</span> {</span>
        <span class="hljs-keyword">if</span> (lastInput) {
          <span class="hljs-keyword">switch</span> (lastInput.key) {

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_LEFT:
            <span class="hljs-keyword">case</span> cwt.Input.TYPE_RIGHT:
            <span class="hljs-keyword">case</span> cwt.Input.TYPE_UP:
            <span class="hljs-keyword">case</span> cwt.Input.TYPE_DOWN:
              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.layout.handleInput(lastInput)) {
                <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">false</span>;
                cwt.Audio.playSound(<span class="hljs-string">"MENU_TICK"</span>);
              }
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_ACTION:
              <span class="hljs-keyword">var</span> button = <span class="hljs-keyword">this</span>.layout.activeButton();
              button.action.call(<span class="hljs-keyword">this</span>, button, <span class="hljs-keyword">this</span>);
              <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">false</span>;
              cwt.Audio.playSound(<span class="hljs-string">"ACTION"</span>);
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Input.TYPE_CANCEL:
              <span class="hljs-keyword">if</span> (desc.last) {
                cwt.Gameflow.changeState(desc.last);
                cwt.Audio.playSound(<span class="hljs-string">"CANCEL"</span>);
              }
              <span class="hljs-keyword">break</span>;
          }
        }
      },

      render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta)</span> {</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.rendered) {
          <span class="hljs-keyword">var</span> ctx = cwt.Screen.layerUI.getContext();
          <span class="hljs-keyword">this</span>.layout.draw(ctx);
          <span class="hljs-keyword">this</span>.rendered = <span class="hljs-literal">true</span>;
        }
      }
    });
  },

  <span class="hljs-comment">/**
   * Initializes the game state machine.
   */</span>
  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) {
      console.log(<span class="hljs-string">"starting game state machine"</span>);
    }

    <span class="hljs-keyword">var</span> oldTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gameLoop</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>acquire next frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      requestAnimationFrame(gameLoop);</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>calculate delta</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
      <span class="hljs-keyword">var</span> delta = now - oldTime;
      oldTime = now;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>update machine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.Gameflow.update(delta);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>set start state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setState(<span class="hljs-string">"NONE"</span>, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>enter the loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    requestAnimationFrame(gameLoop);
  },

  <span class="hljs-comment">/**
   *
   * @param stateId
   */</span>
  changeState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(stateId)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.activeState) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>exit old state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.activeState.exit) {
        <span class="hljs-keyword">this</span>.activeState.exit.call(<span class="hljs-keyword">this</span>.activeState.data);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>enter new state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setState(stateId, <span class="hljs-literal">true</span>);
  },

  <span class="hljs-comment">/**
   *
   * @param stateId
   */</span>
  setState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(stateId, fireEvent)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.states_.hasOwnProperty(stateId));

    <span class="hljs-keyword">if</span> (cwt.DEBUG) {
      console.log(<span class="hljs-string">"set active state to "</span> + stateId + ((fireEvent) ? <span class="hljs-string">" with firing enter event"</span> : <span class="hljs-string">""</span>));
    }

    <span class="hljs-keyword">this</span>.activeState = <span class="hljs-keyword">this</span>.states_[stateId];
    <span class="hljs-keyword">this</span>.activeStateId = stateId;

    <span class="hljs-keyword">if</span> (fireEvent !== <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">this</span>.activeState.enter.call(<span class="hljs-keyword">this</span>.activeState.data);
    }
  },

  <span class="hljs-comment">/**
   *
   * @param delta
   */</span>
  update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>update game-pad controls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.ClientFeatures.gamePad &amp;&amp; cwt.Input.types.gamePad.update) {
      cwt.Input.types.gamePad.update();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>state update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> inp = cwt.Input.popAction();
    <span class="hljs-keyword">this</span>.activeState.update.call(<span class="hljs-keyword">this</span>.activeState.data, delta, inp);
    <span class="hljs-keyword">this</span>.activeState.render.call(<span class="hljs-keyword">this</span>.activeState.data, delta);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>release input data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (inp) {
      cwt.Input.pool.push(inp);
    }
  }
};

<span class="hljs-comment">/**
 * @namespace
 */</span>
cwt.Image = {

  <span class="hljs-comment">/**
   * @constant
   */</span>
  IMAGE_KEY: <span class="hljs-string">"GFX_"</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_UNIT: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_PROPERTY: <span class="hljs-number">1</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_TILE: <span class="hljs-number">2</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_ANIMATED_TILE: <span class="hljs-number">3</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_ANIMATED_TILE_WITH_VARIANTS: <span class="hljs-number">4</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_MISC: <span class="hljs-number">10</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  TYPE_IMAGE: <span class="hljs-number">99</span>,

  <span class="hljs-comment">/**
   * Color schema for a unit sprite.
   *
   * @constant
   */</span>
  UNIT_INDEXES: {
    RED: <span class="hljs-number">0</span>,
    BLUE: <span class="hljs-number">3</span>,
    GREEN: <span class="hljs-number">4</span>,
    YELLOW: <span class="hljs-number">5</span>,
    colors: <span class="hljs-number">6</span>
  },

  <span class="hljs-comment">/**
   * Color schema for a property sprite.
   *
   * @constant
   */</span>
  PROPERTY_INDEXES: {
    RED: <span class="hljs-number">0</span>,
    GRAY: <span class="hljs-number">1</span>,
    BLUE: <span class="hljs-number">3</span>,
    GREEN: <span class="hljs-number">4</span>,
    YELLOW: <span class="hljs-number">5</span>,
    colors: <span class="hljs-number">4</span>
  },

  <span class="hljs-comment">/**
   * @type {object.&lt;cwt.Sprite&gt;}
   */</span>
  sprites: {},

  overlayTiles: {},

  longAnimatedTiles: {},

  <span class="hljs-comment">/**
   *
   * @param type
   * @param sprite
   * @param callback
   */</span>
  saveSpriteToCache: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, sprite, callback)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(sprite <span class="hljs-keyword">instanceof</span> cwt.ArmySprite || sprite <span class="hljs-keyword">instanceof</span> cwt.Sprite);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>extract data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> data = (sprite <span class="hljs-keyword">instanceof</span> cwt.ArmySprite) ? cwt.ArmySprite.toJSON(sprite) : cwt.Sprite.toJSON(sprite);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>save it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Storage.assetsStorage.set(type, data, callback);
  },

  <span class="hljs-comment">/**
   *
   * @param type
   * @param path
   * @param callback
   */</span>
  loadSprite: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, path, imgType, callback)</span> {</span>
    cwt.Storage.assetsStorage.get(type, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
      <span class="hljs-keyword">if</span> (obj.value) {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>is in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.sprites[type] = <span class="hljs-keyword">this</span>.jSONtoColoredSprite_(obj.value);
        callback();

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>not in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
        img.src = path;

        img.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> sprite;

          <span class="hljs-keyword">switch</span> (imgType) {
            <span class="hljs-keyword">case</span> cwt.Image.TYPE_UNIT:
              sprite = cwt.Image.createUnitSprites();
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Image.TYPE_PROPERTY:
              sprite = cwt.Image.createPropertySprites();
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> cwt.Image.TYPE_TILE:
              sprite = cwt.Image.createTileSprites();
              <span class="hljs-keyword">break</span>;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>save image in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cwt.Image.saveSpriteToCache(type, sprite, callback);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>failed to load the image data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        img.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"could not load image for "</span> + type + <span class="hljs-string">" at location "</span> + path);
        };
      }
    });
  },

  createUnitSprites: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>crop idle, left, up, down</p>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>flip idle and left</p>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>colorize all</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },

  createPropertySprites: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>colorize it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },

  createTileSprites: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>crop all tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },

  <span class="hljs-comment">/**
   *
   * @private
   */</span>
  removeGrabbers_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    cwt.Image.removeGrabbers_ = <span class="hljs-literal">null</span>;
    cwt.Image.grabFromRemote = <span class="hljs-literal">null</span>;
    cwt.Image.grabFromCache = <span class="hljs-literal">null</span>;
  },

  <span class="hljs-comment">/**
   *
   * @param {Function} callback
   */</span>
  grabFromRemote: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.removeGrabbers_(); <span class="hljs-comment">// remove initializer functions</span>

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getImageDataArray</span><span class="hljs-params">(image)</span> {</span>
      <span class="hljs-keyword">var</span> canvas = document.createElement(<span class="hljs-string">"canvas"</span>);
      <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);

      <span class="hljs-keyword">var</span> imgW = image.width;
      <span class="hljs-keyword">var</span> imgH = image.height;
      canvas.width = imgW;
      canvas.height = imgH;
      canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">return</span> canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH).data;
    }

    <span class="hljs-comment">/**
     * Changes colors in an assets object by given replacement color maps and returns a new assets
     * object (html5 canvas).
     *
     * @inner
     * @param image
     * @param colorData
     * @param numColors
     * @param oriIndex
     * @param replaceIndex
     * @return {HTMLCanvasElement}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceColors</span><span class="hljs-params">(image, colorData, numColors, oriIndex, replaceIndex)</span> {</span>
      <span class="hljs-keyword">var</span> canvas = document.createElement(<span class="hljs-string">"canvas"</span>);
      <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> imgW = image.width;
      <span class="hljs-keyword">var</span> imgH = image.height;
      canvas.width = imgW;
      canvas.height = imgH;
      canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> imgPixels = canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);

      <span class="hljs-keyword">var</span> oriStart = (oriIndex * <span class="hljs-number">4</span>) * numColors;
      <span class="hljs-keyword">var</span> replStart = (replaceIndex * <span class="hljs-number">4</span>) * numColors;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixels.height; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixels.width; x++) {
          <span class="hljs-keyword">var</span> xi = (y * <span class="hljs-number">4</span>) * imgPixels.width + x * <span class="hljs-number">4</span>;

          <span class="hljs-keyword">var</span> oR = imgPixels.data[xi  ];
          <span class="hljs-keyword">var</span> oG = imgPixels.data[xi + <span class="hljs-number">1</span>];
          <span class="hljs-keyword">var</span> oB = imgPixels.data[xi + <span class="hljs-number">2</span>];
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>, ne = (numColors * <span class="hljs-number">4</span>); n &lt; ne; n += <span class="hljs-number">4</span>) {

            <span class="hljs-keyword">var</span> sR = colorData[oriStart + n  ];
            <span class="hljs-keyword">var</span> sG = colorData[oriStart + n + <span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> sB = colorData[oriStart + n + <span class="hljs-number">2</span>];

            <span class="hljs-keyword">if</span> (sR === oR &amp;&amp; sG === oG &amp;&amp; sB === oB) {

              <span class="hljs-keyword">var</span> r = replStart + n;
              <span class="hljs-keyword">var</span> rR = colorData[r  ];
              <span class="hljs-keyword">var</span> rG = colorData[r + <span class="hljs-number">1</span>];
              <span class="hljs-keyword">var</span> rB = colorData[r + <span class="hljs-number">2</span>];
              imgPixels.data[xi  ] = rR;
              imgPixels.data[xi + <span class="hljs-number">1</span>] = rG;
              imgPixels.data[xi + <span class="hljs-number">2</span>] = rB;
            }
          }
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>write changes back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      canvasContext.putImageData(imgPixels, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

      <span class="hljs-keyword">return</span> canvas;
    }

    <span class="hljs-comment">/**
     *
     * @inner
     * @param {HTMLImageElement|HTMLCanvasElement} image
     * @return {HTMLCanvasElement}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createBlackMask</span><span class="hljs-params">(image)</span> {</span>
      <span class="hljs-keyword">var</span> canvas = document.createElement(<span class="hljs-string">"canvas"</span>);
      <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> imgW = image.width;
      <span class="hljs-keyword">var</span> imgH = image.height;
      canvas.width = imgW;
      canvas.height = imgH;
      canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> imgPixels = canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixels.height; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixels.width; x++) {
          <span class="hljs-keyword">var</span> xi = (y * <span class="hljs-number">4</span>) * imgPixels.width + x * <span class="hljs-number">4</span>;
          <span class="hljs-keyword">var</span> oA = imgPixels.data[xi + <span class="hljs-number">3</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>if pixel is not transparent, then fill it with black</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (oA &gt; <span class="hljs-number">0</span>) {
            imgPixels.data[xi  ] = <span class="hljs-number">0</span>;
            imgPixels.data[xi + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
            imgPixels.data[xi + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
          }
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>write changes back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      canvasContext.putImageData(imgPixels, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

      <span class="hljs-keyword">return</span> canvas;
    }

    <span class="hljs-comment">/**
     * Draws a part of an image to a new canvas.
     *
     * @inner
     * @param {HTMLImageElement|HTMLCanvasElement} image image object
     * @param {number} sx source x coordinate
     * @param {number} sy source y coordinate
     * @param {number} w width
     * @param {number} h height
     * @return {HTMLCanvasElement}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropImage</span><span class="hljs-params">(image, sx, sy, w, h)</span> {</span>
      <span class="hljs-keyword">var</span> nCanvas = document.createElement(<span class="hljs-string">'canvas'</span>);
      <span class="hljs-keyword">var</span> nContext = nCanvas.getContext(<span class="hljs-string">'2d'</span>);

      nCanvas.width = w;
      nCanvas.height = h;

      nContext.drawImage(image, sx, sy, w, h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h);

      <span class="hljs-keyword">return</span> <span class="hljs-comment">/** @type {HTMLCanvasElement} */</span> nCanvas;
    }

    <span class="hljs-comment">/**
     * Flips an image.
     *
     * BASED ON http://jsfiddle.net/pankajparashar/KwDhX/
     *
     * @inner
     * @param {Image|HTMLCanvasElement} image
     * @param {boolean} flipH
     * @param {boolean} flipV
     * @return {HTMLCanvasElement}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flipImage</span><span class="hljs-params">(image, flipH, flipV)</span> {</span>
      <span class="hljs-keyword">var</span> scaleH = flipH ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> scaleV = flipV ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> posX = flipH ? image.width * -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> posY = flipV ? image.height * -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> nCanvas = document.createElement(<span class="hljs-string">'canvas'</span>);
      <span class="hljs-keyword">var</span> nContext = nCanvas.getContext(<span class="hljs-string">'2d'</span>);

      nCanvas.height = image.height;
      nCanvas.width = image.width;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>transform it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      nContext.save();
      nContext.scale(scaleH, scaleV);
      nContext.drawImage(image, posX, posY, image.width, image.height);
      nContext.restore();

      <span class="hljs-keyword">return</span> <span class="hljs-comment">/** @type {HTMLCanvasElement} */</span> nCanvas;
    }

    <span class="hljs-comment">/**
     * Doubles the size of an assets by using the scale2x algorithm.
     *
     * @inner
     * @param image
     * @return {HTMLElement}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scale2x</span><span class="hljs-params">(image)</span> {</span>
      <span class="hljs-keyword">var</span> imgW = image.width;
      <span class="hljs-keyword">var</span> imgH = image.height;
      <span class="hljs-keyword">var</span> oR, oG, oB;
      <span class="hljs-keyword">var</span> uR, uG, uB;
      <span class="hljs-keyword">var</span> dR, dG, dB;
      <span class="hljs-keyword">var</span> rR, rG, rB;
      <span class="hljs-keyword">var</span> lR, lG, lB;
      <span class="hljs-keyword">var</span> xi;
      <span class="hljs-keyword">var</span> t0R, t0G, t0B;
      <span class="hljs-keyword">var</span> t1R, t1G, t1B;
      <span class="hljs-keyword">var</span> t2R, t2G, t2B;
      <span class="hljs-keyword">var</span> t3R, t3G, t3B;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> canvasS = document.createElement(<span class="hljs-string">"canvas"</span>);
      <span class="hljs-keyword">var</span> canvasSContext = canvasS.getContext(<span class="hljs-string">"2d"</span>);
      canvasS.width = imgW;
      canvasS.height = imgH;
      canvasSContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">var</span> imgPixelsS = canvasSContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> canvasT = document.createElement(<span class="hljs-string">"canvas"</span>);
      <span class="hljs-keyword">var</span> canvasTContext = canvasT.getContext(<span class="hljs-string">"2d"</span>);
      canvasT.width = imgW * <span class="hljs-number">2</span>;
      canvasT.height = imgH * <span class="hljs-number">2</span>;
      <span class="hljs-keyword">var</span> imgPixelsT = canvasTContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW * <span class="hljs-number">2</span>, imgH * <span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>scale it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixelsS.height; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixelsS.width; x++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
grab source pixels</p>

            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>grab center</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + x * <span class="hljs-number">4</span>;
          oR = imgPixelsS.data[xi ];
          oG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
          oB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>grab left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
            xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + (x - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
            lR = imgPixelsS.data[xi ];
            lG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
            lB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
          }
          <span class="hljs-keyword">else</span> {
            lR = oR;
            lG = oG;
            lB = oB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>grab up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) {
            xi = ((y - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsS.width + (x) * <span class="hljs-number">4</span>;
            uR = imgPixelsS.data[xi ];
            uG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
            uB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
          }
          <span class="hljs-keyword">else</span> {
            uR = oR;
            uG = oG;
            uB = oB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>grab down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (x &lt; imgPixelsS.height - <span class="hljs-number">1</span>) {
            xi = ((y + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsS.width + (x) * <span class="hljs-number">4</span>;
            dR = imgPixelsS.data[xi ];
            dG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
            dB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
          }
          <span class="hljs-keyword">else</span> {
            dR = oR;
            dG = oG;
            dB = oB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>grab right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (x &lt; imgPixelsS.width - <span class="hljs-number">1</span>) {
            xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + (x + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
            rR = imgPixelsS.data[xi ];
            rG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
            rB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
          }
          <span class="hljs-keyword">else</span> {
            rR = oR;
            rG = oG;
            rB = oB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
calculates target pixels</p>

            </div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>E0 = E; E1 = E; E2 = E; E3 = E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          t0R = oR;
          t0G = oG;
          t0B = oB;
          t1R = oR;
          t1G = oG;
          t1B = oB;
          t2R = oR;
          t2G = oG;
          t2B = oB;
          t3R = oR;
          t3G = oG;
          t3B = oB;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>if (B != H &amp;&amp; D != F)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (( uR !== dR || uG !== dG || uB !== dB ) &amp;&amp; ( lR !== rR || lG !== rG || lB !== rB )) {</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>E0 = D == B ? D : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (uR === lR &amp;&amp; uG === lG &amp;&amp; uB === lB) {
              t0R = lR;
              t0G = lG;
              t0B = lB;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>E1 = B == F ? F : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (uR === rR &amp;&amp; uG === rG &amp;&amp; uB === rB) {
              t1R = rR;
              t1G = rG;
              t1B = rB;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>E2 = D == H ? D : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (lR === dR &amp;&amp; lG === dG &amp;&amp; lB === dB) {
              t2R = lR;
              t2G = lG;
              t2B = lB;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>E3 = H == F ? F : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (dR === rR &amp;&amp; dG === rG &amp;&amp; dB === rB) {
              t3R = rR;
              t3G = rG;
              t3B = rB;
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
write pixels to target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
          xi = ((y * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>) * imgPixelsT.width + (x * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>;
          imgPixelsT.data[xi + <span class="hljs-number">0</span>] = t0R;
          imgPixelsT.data[xi + <span class="hljs-number">1</span>] = t0G;
          imgPixelsT.data[xi + <span class="hljs-number">2</span>] = t0B;
          imgPixelsT.data[xi + <span class="hljs-number">4</span>] = t1R;
          imgPixelsT.data[xi + <span class="hljs-number">5</span>] = t1G;
          imgPixelsT.data[xi + <span class="hljs-number">6</span>] = t1B;

          xi = ((y * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsT.width + (x * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>;
          imgPixelsT.data[xi + <span class="hljs-number">0</span>] = t2R;
          imgPixelsT.data[xi + <span class="hljs-number">1</span>] = t2G;
          imgPixelsT.data[xi + <span class="hljs-number">2</span>] = t2B;
          imgPixelsT.data[xi + <span class="hljs-number">4</span>] = t3R;
          imgPixelsT.data[xi + <span class="hljs-number">5</span>] = t3G;
          imgPixelsT.data[xi + <span class="hljs-number">6</span>] = t3B;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>write changes back to the canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      canvasTContext.putImageData(imgPixelsT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

      canvasS = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> canvasT;
    }

    <span class="hljs-comment">/**
     *
     * @inner
     * @param sprite
     * @param state
     * @param rImg
     * @param bImg
     * @param gImg
     * @param yImg
     * @param startX
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropUnitState</span><span class="hljs-params">(sprite, state, rImg, bImg, gImg, yImg, startX)</span> {</span>
      sprite.setImage(cwt.Sprite.UNIT_RED + state, cropImage(rImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(cwt.Sprite.UNIT_BLUE + state, cropImage(bImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(cwt.Sprite.UNIT_GREEN + state, cropImage(gImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(cwt.Sprite.UNIT_YELLOW + state, cropImage(yImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(cwt.Sprite.UNIT_SHADOW_MASK + state,
        createBlackMask(sprite.getImage(cwt.Sprite.UNIT_RED + state)));
    }

    <span class="hljs-comment">/**
     *
     * @inner
     * @param sprite
     * @param state
     * @param rImg
     * @param bImg
     * @param gImg
     * @param yImg
     * @param startX
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropUnitStateInverted</span><span class="hljs-params">(sprite, state, rImg, bImg, gImg, yImg, startX)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>TODO: bug flips whole image, but it would be correct to flip every state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      sprite.setImage(cwt.Sprite.UNIT_RED + state, flipImage(cropImage(rImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
      sprite.setImage(cwt.Sprite.UNIT_BLUE + state, flipImage(cropImage(bImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
      sprite.setImage(cwt.Sprite.UNIT_GREEN + state, flipImage(cropImage(gImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
      sprite.setImage(cwt.Sprite.UNIT_YELLOW + state, flipImage(cropImage(yImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
      sprite.setImage(cwt.Sprite.UNIT_SHADOW_MASK + state,
        createBlackMask(sprite.getImage(cwt.Sprite.UNIT_RED + state)));
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropAndRotate</span><span class="hljs-params">(image, sx, sy, w, rotation)</span> {</span>
      <span class="hljs-keyword">var</span> canvas = document.createElement(<span class="hljs-string">'canvas'</span>);
      <span class="hljs-keyword">var</span> context = canvas.getContext(<span class="hljs-string">'2d'</span>);
      <span class="hljs-keyword">var</span> hw = w / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(hw % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>);

      canvas.height = w;
      canvas.width = w;</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>transform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      context.save();
      context.translate(hw, hw);
      context.rotate(rotation * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>);
      context.translate(-hw, -hw);</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>draw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      context.drawImage(image, sx, sy, w, w, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, w);

      context.restore();

      <span class="hljs-keyword">return</span> canvas;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">grabImage</span><span class="hljs-params">(path, key, callback)</span> {</span>
      <span class="hljs-keyword">if</span> (cwt.DEBUG) {
        console.log(<span class="hljs-string">"going to load image "</span> + path + <span class="hljs-string">" for key "</span> + key);
      }

      <span class="hljs-keyword">var</span> image = <span class="hljs-keyword">new</span> Image();

      <span class="hljs-keyword">if</span> (cwt.DEBUG) {
        image.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          console.log(<span class="hljs-string">"successfully loaded image "</span> + path + <span class="hljs-string">" for key "</span> + key);
          callback.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
        };
      } <span class="hljs-keyword">else</span> {
        image.onload = callback;
      }

      image.src = cwt.MOD_PATH + path;
      image.key = key;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> unitColorData;
    <span class="hljs-keyword">var</span> propertyColorData;
    <span class="hljs-keyword">var</span> unitColStat = cwt.Image.UNIT_INDEXES;
    <span class="hljs-keyword">var</span> propColStat = cwt.Image.PROPERTY_INDEXES;

    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToPushLoop</span><span class="hljs-params">(path, key, callback)</span> {</span>
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          callback(<span class="hljs-keyword">this</span>, next);
        });
      })
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>grab color map images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stuff.push(
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        grabImage(cwt.Graphics.COLOR_MAP[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          propertyColorData = getImageDataArray(<span class="hljs-keyword">this</span>);
          next();
        });
      },
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        grabImage(cwt.Graphics.COLOR_MAP[<span class="hljs-number">1</span>], <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          unitColorData = getImageDataArray(<span class="hljs-keyword">this</span>);
          next();
        });
      }
    );</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>grab unit images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(cwt.Graphics.UNITS).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        <span class="hljs-keyword">var</span> path = cwt.Graphics.UNITS[key];
        grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> cwt.Sprite(cwt.Sprite.UNIT_STATES);

          <span class="hljs-keyword">var</span> red = <span class="hljs-comment">/** @type {HTMLImageElement} */</span> <span class="hljs-keyword">this</span>;
          <span class="hljs-keyword">var</span> blue;
          <span class="hljs-keyword">var</span> green;
          <span class="hljs-keyword">var</span> yellow;</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>create colored sprite maps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          blue = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.BLUE);
          green = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.GREEN);
          yellow = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.YELLOW);</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>crop out target states as single images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cropUnitState(sprite, cwt.Sprite.UNIT_STATE_IDLE, red, blue, green, yellow, <span class="hljs-number">0</span>);
          cropUnitState(sprite, cwt.Sprite.UNIT_STATE_UP, red, blue, green, yellow, <span class="hljs-number">96</span>);
          cropUnitState(sprite, cwt.Sprite.UNIT_STATE_DOWN, red, blue, green, yellow, <span class="hljs-number">192</span>);
          cropUnitState(sprite, cwt.Sprite.UNIT_STATE_LEFT, red, blue, green, yellow, <span class="hljs-number">288</span>);
          cropUnitStateInverted(sprite, cwt.Sprite.UNIT_STATE_IDLE_INVERTED, red, blue, green, yellow, <span class="hljs-number">0</span>);
          cropUnitStateInverted(sprite, cwt.Sprite.UNIT_STATE_RIGHT, red, blue, green, yellow, <span class="hljs-number">288</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
          next();
        });
      });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>grab tile images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(cwt.Graphics.TILES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> value = cwt.Graphics.TILES[key];
      <span class="hljs-keyword">var</span> sprite;</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>special graphic data for tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">2</span>] === <span class="hljs-literal">true</span>) {
        cwt.Image.longAnimatedTiles[key] = <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">1</span>] === <span class="hljs-literal">true</span>) {
        cwt.Image.overlayTiles[key] = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">if</span> (value.length === <span class="hljs-number">3</span>) { <span class="hljs-comment">// single variant tile</span>
        sprite = <span class="hljs-keyword">new</span> cwt.Sprite(cwt.Sprite.TILE_STATES);
        stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
          grabImage(value[<span class="hljs-number">0</span>], key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            sprite.setImage(<span class="hljs-number">0</span>, <span class="hljs-comment">/** @type {HTMLImageElement}*/</span> <span class="hljs-keyword">this</span>);
            sprite.setImage(<span class="hljs-number">1</span>,createBlackMask(<span class="hljs-keyword">this</span>));
            next();
          });
        });

      } <span class="hljs-keyword">else</span> {                  <span class="hljs-comment">// multi variant tile</span>
        sprite = <span class="hljs-keyword">new</span> cwt.Sprite(value[<span class="hljs-number">2</span>].length*cwt.Sprite.TILE_STATES);

        cwt.TileVariants.registerVariantInfo(key, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = value[<span class="hljs-number">2</span>].length; i &lt; e; i++) {
          addToPushLoop(value[<span class="hljs-number">2</span>][i], i*<span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img, next)</span> {</span>
            sprite.setImage(img.key, img);
            sprite.setImage(img.key+<span class="hljs-number">1</span>,createBlackMask(img));
            next();
          });
        }
      }

      cwt.Image.sprites[key] = sprite;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>grab property images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(cwt.Graphics.PROPERTIES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        <span class="hljs-keyword">var</span> path = cwt.Graphics.PROPERTIES[key];
        grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> cwt.Sprite(cwt.Sprite.PROPERTY_STATES);

          <span class="hljs-keyword">var</span> red = <span class="hljs-comment">/** @type {HTMLImageElement} */</span> <span class="hljs-keyword">this</span>;
          <span class="hljs-keyword">var</span> blue;
          <span class="hljs-keyword">var</span> green;
          <span class="hljs-keyword">var</span> yellow;
          <span class="hljs-keyword">var</span> neutral;
          <span class="hljs-keyword">var</span> shadow;

          blue = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.BLUE);
          green = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.GREEN);
          yellow = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.YELLOW);
          neutral = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.GRAY);
          shadow = createBlackMask(red);

          sprite.setImage(cwt.Sprite.PROPERTY_RED, red);
          sprite.setImage(cwt.Sprite.PROPERTY_BLUE, blue);
          sprite.setImage(cwt.Sprite.PROPERTY_GREEN, green);
          sprite.setImage(cwt.Sprite.PROPERTY_YELLOW, yellow);
          sprite.setImage(cwt.Sprite.PROPERTY_NEUTRAL, neutral);
          sprite.setImage(cwt.Sprite.PROPERTY_SHADOW_MASK, shadow);</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
          next();
        });
      });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>grab arrow images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
      <span class="hljs-keyword">var</span> path = cwt.Graphics.ARROW;
      grabImage(path, <span class="hljs-string">"ARROW"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> cwt.Sprite(<span class="hljs-number">10</span>);

        <span class="hljs-keyword">var</span> arrowMap = <span class="hljs-comment">/** @type {HTMLImageElement} */</span> <span class="hljs-keyword">this</span>;

        sprite.setImage(cwt.Sprite.DIRECTION_N, cropImage(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_S, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">180</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_W, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">270</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_E, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_SW, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_SE, cropImage(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_NW, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">180</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_NE, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">270</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_NS, cropImage(arrowMap, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_WE, cropAndRotate(arrowMap, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
        next();
      });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>grab dust images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
      <span class="hljs-keyword">var</span> path = cwt.Graphics.DUST;
      grabImage(path, <span class="hljs-string">"DUST"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> cwt.Sprite(<span class="hljs-number">4</span>);

        <span class="hljs-keyword">var</span> imgMap = <span class="hljs-comment">/** @type {HTMLImageElement} */</span> <span class="hljs-keyword">this</span>;

        sprite.setImage(cwt.Sprite.DIRECTION_LEFT, cropImage(imgMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_UP, cropImage(imgMap, <span class="hljs-number">96</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_DOWN, cropImage(imgMap, <span class="hljs-number">192</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
        sprite.setImage(cwt.Sprite.DIRECTION_RIGHT, cropImage(imgMap, <span class="hljs-number">288</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
        next();
      });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>grab rocket fly images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
      <span class="hljs-keyword">var</span> path = cwt.Graphics.ROCKET_FLY;
      grabImage(path, <span class="hljs-string">"ROCKET_FLY"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> cwt.Sprite(<span class="hljs-number">2</span>);

        sprite.setImage(cwt.Sprite.DIRECTION_UP, <span class="hljs-comment">/** @type {HTMLImageElement} */</span> <span class="hljs-keyword">this</span>);
        sprite.setImage(cwt.Sprite.DIRECTION_DOWN, cropAndRotate(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">180</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
        next();
      });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>grab other images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(cwt.Graphics.OTHERS).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> value = cwt.Graphics.OTHERS[key];
      <span class="hljs-keyword">var</span> sprite;

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
        sprite = <span class="hljs-keyword">new</span> cwt.Sprite(<span class="hljs-number">1</span>);

        stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>      <span class="hljs-comment">// single image sprite</span>
          grabImage(value, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            sprite.setImage(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>);
            cwt.Image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
            next();
          });
        });
      } <span class="hljs-keyword">else</span> {                            <span class="hljs-comment">// multi image sprite</span>
        sprite = <span class="hljs-keyword">new</span> cwt.Sprite(value.length);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = value.length; i &lt; e; i++) {
          addToPushLoop(value[i], i, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img, next)</span> {</span>
            sprite.setImage(img.key, img);
            next();
          });
        }
      }

      cwt.Image.sprites[key] = sprite;
    });

    callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">delete</span> cwt.Graphics;
      callback();
    });
  },

  <span class="hljs-comment">/**
   *
   * @param callback
   */</span>
  persistImages: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) {
      console.log(<span class="hljs-string">"persist all images in the cache"</span>);
    }

    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-built_in">Object</span>.keys(cwt.Image.sprites).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> sprite = cwt.Image.sprites[key];
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        cwt.Storage.assetsStorage.set(
          cwt.Image.IMAGE_KEY+key,
          cwt.Sprite.toJSON(cwt.Image.sprites[key]),
          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            next();
          }
        )
      });
    });

    callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span> (cwt.DEBUG) {
        console.log(<span class="hljs-string">"completed image persist process"</span>);
      }

      callback();
    });
  },


  <span class="hljs-comment">/**
   *
   * @param {Function} callback
   */</span>
  grabFromCache: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.removeGrabbers_(); <span class="hljs-comment">// remove initializer functions</span>

    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-comment">/**
     * @inner
     * @param key
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadKey</span><span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> realKey = key.slice(cwt.Image.IMAGE_KEY.length);
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        <span class="hljs-keyword">if</span> (cwt.DEBUG) {
          console.log(<span class="hljs-string">"grab sprite "</span>+key+<span class="hljs-string">" from cache"</span>);
        }

        cwt.Storage.assetsStorage.get(key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
          <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(obj.value);

          cwt.Image.sprites[realKey] = cwt.Sprite.fromJSON(obj.value);

          next();
        });
      })
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>load all possible audio (except music) keys from the storage into the RAM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Storage.assetsStorage.keys(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keys)</span> {</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = keys.length; i &lt; e; i++) {
        <span class="hljs-keyword">var</span> key = keys[i];
        <span class="hljs-keyword">if</span> (key.indexOf(cwt.Image.IMAGE_KEY) === <span class="hljs-number">0</span>) {
          loadKey(key);
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>grab tile variant information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">Object</span>.keys(cwt.Graphics.TILES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
        <span class="hljs-keyword">var</span> value = cwt.Graphics.TILES[key];</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>special graphic data for tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">2</span>] === <span class="hljs-literal">true</span>) {
          cwt.Image.longAnimatedTiles[key] = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">1</span>] === <span class="hljs-literal">true</span>) {
          cwt.Image.overlayTiles[key] = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (value.length !== <span class="hljs-number">3</span>) { <span class="hljs-comment">// multi variant tile</span>
          cwt.TileVariants.registerVariantInfo(key, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>]);
        }
      });

      callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        callback();
      });
    });
  }

};

<span class="hljs-comment">/**
 * The data loading process.
 *
 * @namespace
 */</span>
cwt.Loading = {

  <span class="hljs-comment">/**
   * @private
   */</span>
  loaders_: [],

  hasCachedData: <span class="hljs-literal">false</span>,

  <span class="hljs-comment">/**
   * Adds a loading function in the loading process.
   *
   * @param {Function} loader
   */</span>
  create: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(loader)</span> {</span>
    <span class="hljs-keyword">this</span>.loaders_.push(loader);
  },

  <span class="hljs-comment">/**
   * Starts the loading process. After the loading process the loading stuff will be removed. The Loading namespace
   * will remain with a property with value true as marker. This property will be named deInitialized.
   *
   * @param {Function} callback
   */</span>
  startProcess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(loadingBar, callback)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) {
      console.log(<span class="hljs-string">"start loading process"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setProgress</span><span class="hljs-params">(bar,i)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        bar.setPercentage(i);
        next();
      }
    }

    cwt.Loading.hasCachedData = localStorage.getItem(<span class="hljs-string">"cwt_hasCache"</span>);

    <span class="hljs-keyword">var</span> loaders = [];
    <span class="hljs-keyword">var</span> step = <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">100</span>/<span class="hljs-keyword">this</span>.loaders_.length);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e=<span class="hljs-keyword">this</span>.loaders_.length; i&lt;e; i++ ){
      loaders.push(<span class="hljs-keyword">this</span>.loaders_[i]);
      loaders.push(setProgress(loadingBar,(i+<span class="hljs-number">1</span>)*step));
    }

    callAsSequence(loaders, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>remove functions that never be called again</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.loaders_;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.create;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.startProcess;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>place marker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.initialized = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>invoke callback if given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (callback) {
        localStorage.setItem(<span class="hljs-string">"cwt_hasCache"</span>,<span class="hljs-literal">true</span>);

        callback();
      }
    });
  }
};

<span class="hljs-comment">/**
 * Localization module to grab localized strings
 * from a given key. The language can be registered
 * by registerLang.
 *
 * @namespace
 */</span>
cwt.Localization = {

  <span class="hljs-comment">/**
   * @private
   */</span>
  lang_ : <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Registers a language object. The properties of the object will be the keys and its values the localized
   * string for the key.
   *
   * @param obj
   */</span>
  registerLang: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(!<span class="hljs-keyword">this</span>.lang_);

    <span class="hljs-keyword">this</span>.lang_ = obj;
  },

  <span class="hljs-comment">/**
   * Returns the localized string of a given identifier.
   *
   * @param {String} key identifier
   * @return {String}
   */</span>
  forKey: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.lang_ !== <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">var</span> str = <span class="hljs-keyword">this</span>.lang_[key];
    <span class="hljs-keyword">return</span> (str) ? str : key;
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Maps = {

  <span class="hljs-comment">/**
   * @type {Array}
   */</span>
  maps: <span class="hljs-literal">null</span>,

  updateMapList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    cwt.Storage.mapStorage.keys(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keys)</span> {</span>
      cwt.Maps.maps = keys;
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
    })
  },

  grabFromLive: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">var</span> stuff = [];

    <span class="hljs-built_in">Object</span>.keys(cwt.mapList).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
        grabRemoteFile({
          path: cwt.MOD_PATH + cwt.mapList[key],
          json: <span class="hljs-literal">true</span>,

          error: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"could not load map"</span>);
          },

          success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resp)</span> {</span>
            cwt.Storage.mapStorage.set(key, resp, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
              next();
            });
          }
        });
      });
    });

    callAsSequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      cwt.Maps.grabFromLive = <span class="hljs-literal">null</span>;
      callback();
    });
  },

  loadMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path, callback)</span> {</span>
    cwt.Storage.mapStorage.get(path, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
      callback(path, obj.value);
    });
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Network = {

  <span class="hljs-comment">/**
   * Id of the game in the connected network session.
   */</span>
  gameId: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Id of the client in the connected network session.
   */</span>
  clientId: cwt.INACTIVE,

  <span class="hljs-comment">/**
   * The target URL of the network server.
   */</span>
  targetURL: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   *
   * @return {Boolean}
   */</span>
  isActive: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.gameId !== <span class="hljs-literal">null</span>;
  },

  <span class="hljs-comment">/**
   *
   * @return {Boolean}
   */</span>
  isHost: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.gameId === <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.clientId !== cwt.INACTIVE;
  },

  <span class="hljs-comment">/**
   * @private
   */</span>
  urlBuilder_:[<span class="hljs-literal">null</span>,<span class="hljs-string">"?cmd="</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">"&amp;gameId="</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">"&amp;userId="</span>,<span class="hljs-literal">null</span>],

  <span class="hljs-comment">/**
   *
   * @private
   */</span>
  parser_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.readyState == <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">this</span>.responseText;
      <span class="hljs-keyword">if</span> (res !== <span class="hljs-string">""</span>) {
        <span class="hljs-keyword">var</span> data = res.split(<span class="hljs-string">"_&amp;_"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = data.length; i &lt; e; i++) {

          <span class="hljs-keyword">if</span> (data[i] !== <span class="hljs-literal">undefined</span> &amp;&amp; data[i].length &gt; <span class="hljs-number">0</span>) network._incomingMessage(data[i]);
        }
      }
    }
  },

  <span class="hljs-comment">/**
   *
   */</span>
  parseMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/*
    var xmlHttp = new XMLHttpRequest();

    this.urlBuilder_[0] = this.targetURL;
    this.urlBuilder_[2] = "GRABCMD";
    this.urlBuilder_[4] = this.gameId;
    this.urlBuilder_[6] = this.clientId;

    xmlHttp.open('GET',this.urlBuilder_.join(""),true);
    xmlHttp.onreadystatechange = this.parser_;
    xmlHttp.send(null);
    */</span>
  },

  <span class="hljs-comment">/**
   *
   * @param obj
   */</span>
  sendMessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>

  }
};

<span class="hljs-comment">/**
 * @namespace
 */</span>
cwt.Options = {

  <span class="hljs-comment">/**
   * @constant
   */</span>
  PARAM_WIPEOUT: <span class="hljs-string">"cwt_resetData"</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  PARAM_FORCE_TOUCH: <span class="hljs-string">"cwt_forceTouch"</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  PARAM_ANIMATED_TILES: <span class="hljs-string">"cwt_animatedTiles"</span>,

  <span class="hljs-comment">/**
   * @type {boolean}
   */</span>
  fastClickMode: <span class="hljs-literal">false</span>,

  <span class="hljs-comment">/**
   * @type {boolean}
   */</span>
  forceTouch: <span class="hljs-literal">false</span>,

  <span class="hljs-comment">/**
   * @type {boolean}
   */</span>
  animatedTiles: <span class="hljs-literal">true</span>,

  <span class="hljs-comment">/**
   *
   * @param cb
   */</span>
  saveOptions: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
    cwt.Storage.generalStorage.set(cwt.Options.PARAM_ANIMATED_TILES, cwt.Options.animatedTiles, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      cwt.Storage.generalStorage.set(cwt.Options.PARAM_FORCE_TOUCH, cwt.Options.forceTouch, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (cb) {
          cb();
        }
      });
    });
  },

  <span class="hljs-comment">/**
   *
   * @param cb
   */</span>
  loadOptions: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
    cwt.Storage.generalStorage.get(cwt.Options.PARAM_ANIMATED_TILES, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
      <span class="hljs-keyword">if</span> (obj) {
        cwt.Options.animatedTiles = obj.value;
      }

      cwt.Storage.generalStorage.get(cwt.Options.PARAM_FORCE_TOUCH, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
        <span class="hljs-keyword">if</span> (obj) {
          cwt.Options.forceTouch = obj.value;
        }

        <span class="hljs-keyword">if</span> (cb) {
          cb();
        }
      });
    });
  }
};

cwt.GameSelectionDTO = {

  <span class="hljs-comment">/**
   * @constant
   */</span>
  CHANGE_TYPE: {
    CO_MAIN: <span class="hljs-number">0</span>,
    CO_SIDE: <span class="hljs-number">1</span>,
    GAME_TYPE: <span class="hljs-number">2</span>,
    PLAYER_TYPE: <span class="hljs-number">3</span>,
    TEAM: <span class="hljs-number">4</span>
  },

  map: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Data holder to remember selected co's.
   */</span>
  co: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   *
   */</span>
  type: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   *
   */</span>
  team: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">/**
   * Changes a configuration parameter.
   *
   * @param pid player id
   * @param type change type
   * @param prev is it a set to previous value step (else next value)
   */</span>
  changeParameter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pid, type, prev)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(type &gt;= <span class="hljs-keyword">this</span>.CHANGE_TYPE.CO_MAIN &amp;&amp; type &lt;= <span class="hljs-keyword">this</span>.CHANGE_TYPE.TEAM);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type[pid] === cwt.DESELECT_ID) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">switch</span> (type) {

      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.CHANGE_TYPE.CO_MAIN:
        <span class="hljs-keyword">var</span> cSelect = <span class="hljs-keyword">this</span>.co[pid];

        <span class="hljs-keyword">if</span> (prev) {
          cSelect--;
          <span class="hljs-keyword">if</span> (cSelect &lt; <span class="hljs-number">0</span>) cSelect = cwt.CoSheet.types.length - <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">else</span> {
          cSelect++;
          <span class="hljs-keyword">if</span> (cSelect &gt;= cwt.CoSheet.types.length) cSelect = <span class="hljs-number">0</span>;
        }

        <span class="hljs-keyword">this</span>.co[pid] = cSelect;
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.CHANGE_TYPE.CO_SIDE:
        cwt.assert(<span class="hljs-literal">false</span>, <span class="hljs-string">"not supported yet"</span>);
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.CHANGE_TYPE.GAME_TYPE:
        <span class="hljs-keyword">if</span> (prev) {
          <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode === cwt.Gameround.GAME_MODE_AW1) {
            cwt.Gameround.gameMode = cwt.Gameround.GAME_MODE_AW2;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode === cwt.Gameround.GAME_MODE_AW2) {
            cwt.Gameround.gameMode = cwt.Gameround.GAME_MODE_AW1;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode === cwt.Gameround.GAME_MODE_AW1) {
            cwt.Gameround.gameMode = cwt.Gameround.GAME_MODE_AW2;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode === cwt.Gameround.GAME_MODE_AW2) {
            cwt.Gameround.gameMode = cwt.Gameround.GAME_MODE_AW1;
          }
        }
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.CHANGE_TYPE.PLAYER_TYPE:
        <span class="hljs-keyword">var</span> cSelect = <span class="hljs-keyword">this</span>.type[pid];
        <span class="hljs-keyword">if</span> (cSelect === cwt.DESELECT_ID) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">if</span> (prev) {
          cSelect--;
          <span class="hljs-keyword">if</span> (cSelect &lt; cwt.INACTIVE) cSelect = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">else</span> {
          cSelect++;
          <span class="hljs-keyword">if</span> (cSelect &gt;= <span class="hljs-number">2</span>) cSelect = cwt.INACTIVE;
        }

        <span class="hljs-keyword">this</span>.type[pid] = cSelect;
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.CHANGE_TYPE.TEAM:
        <span class="hljs-keyword">var</span> cSelect = <span class="hljs-keyword">this</span>.team[pid];

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
          <span class="hljs-keyword">if</span> (prev) {
            cSelect--;
            <span class="hljs-keyword">if</span> (cSelect &lt; <span class="hljs-number">0</span>) cSelect = <span class="hljs-number">3</span>;
          }
          <span class="hljs-keyword">else</span> {
            cSelect++;
            <span class="hljs-keyword">if</span> (cSelect &gt;= <span class="hljs-number">4</span>) cSelect = <span class="hljs-number">0</span>;
          }

          <span class="hljs-keyword">var</span> s = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
            <span class="hljs-keyword">if</span> (i === pid) <span class="hljs-keyword">continue</span>;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type[i] &gt;= <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.team[i] !== cSelect) {
              s = <span class="hljs-literal">true</span>;
            }
          }

          <span class="hljs-keyword">if</span> (s) <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">this</span>.team[pid] = cSelect;
        <span class="hljs-keyword">break</span>;
    }
  },

  <span class="hljs-comment">/**
   * Does some preparations for the configuration screen.
   */</span>
  preProcess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>lazy init config data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.co) {
      <span class="hljs-keyword">this</span>.co = [];
      <span class="hljs-keyword">this</span>.team = [];
      <span class="hljs-keyword">this</span>.type = [];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>reset config data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>; n &lt; cwt.Player.MULTITON_INSTANCES; n++) {
      <span class="hljs-keyword">this</span>.co[n] = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.team[n] = cwt.INACTIVE;
      <span class="hljs-keyword">this</span>.type[n] = <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-keyword">this</span>.map.player) {

        <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">this</span>.type[i] = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.type[i] = <span class="hljs-number">1</span>;

        <span class="hljs-keyword">this</span>.team[i] = i;

      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.type[i] = cwt.DESELECT_ID;
      }
    }
  },

  <span class="hljs-comment">/**
   * Does some preparations for the game round initialization.
   */</span>
  postProcess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> tmp;

    cwt.Player.activeClientPlayer = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>TODO: player one is deactivated</p>

            </div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>deregister old players
controller.ai_reset();
model.events.client_deregisterPlayers();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> onlyAI = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type[i] === <span class="hljs-number">0</span>) {
        onlyAI = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">break</span>;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>update model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">var</span> player = cwt.Player.getInstance(i);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type[i] &gt;= <span class="hljs-number">0</span>) {

        player.gold = <span class="hljs-number">0</span>;
        player.team = <span class="hljs-keyword">this</span>.team[i];

        <span class="hljs-keyword">var</span> cientContrld = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type[i] === <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>controller.ai_register(i);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (onlyAI) {
            cientContrld = <span class="hljs-literal">true</span>;
          }
        } <span class="hljs-keyword">else</span> {
          player.clientVisible = <span class="hljs-literal">true</span>;
          cientContrld = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (cientContrld) {
          <span class="hljs-keyword">if</span> (!cwt.Player.activeClientPlayer) {
            cwt.Player.activeClientPlayer = player;
          }
          player.clientControlled = <span class="hljs-literal">true</span>;
        }

        tmp = ( <span class="hljs-keyword">this</span>.co[i] !== cwt.INACTIVE) ?
          cwt.CoSheet.types[<span class="hljs-keyword">this</span>.co[i]] : <span class="hljs-literal">null</span>;

        cwt.CO.setMainCo(player, tmp);

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Why another disable here ?
There is the possibility that a map has units for a player that will be deactivated in the
config screen.. so deactivate them all</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        cwt.Unit.destroyPlayerUnits(player);
        cwt.Property.releasePlayerProperties(player);</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>deactivate player</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        player.team = cwt.INACTIVE;
      }
    }
  }
};(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">var</span> canvasW = cwt.TILE_BASE * cwt.SCREEN_WIDTH;
  <span class="hljs-keyword">var</span> canvasH = cwt.TILE_BASE * cwt.SCREEN_HEIGHT;

  <span class="hljs-comment">/**
   * Screen model.
   *
   * @namespace
   */</span>
  cwt.Screen = {

    width: canvasW,

    height: canvasH,

    offsetX: <span class="hljs-number">0</span>,

    offsetY: <span class="hljs-number">0</span>,

    convertToTilePos: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(p)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(p/cwt.TILE_BASE,<span class="hljs-number">10</span>);
    },

    <span class="hljs-comment">/**
     *
     * @param moveCode
     */</span>
    shiftScreen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(moveCode)</span> {</span>
      <span class="hljs-keyword">var</span> changed = <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">switch</span> (moveCode) {
        <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_UP:
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.offsetY &lt; cwt.Map.height - cwt.SCREEN_HEIGHT - <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">this</span>.offsetY++;
            changed = <span class="hljs-literal">true</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_RIGHT:
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.offsetX &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.offsetX--;
            changed = <span class="hljs-literal">true</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_DOWN:
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.offsetY &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.offsetY--;
            changed = <span class="hljs-literal">true</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_LEFT:
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.offsetX &lt; cwt.Map.width - cwt.SCREEN_WIDTH - <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">this</span>.offsetX++;
            changed = <span class="hljs-literal">true</span>;
          }
          <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">return</span> changed;
    },

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerBG: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer1"</span>, <span class="hljs-number">1</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerMap: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer2"</span>, <span class="hljs-number">8</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerFog: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer3"</span>, <span class="hljs-number">1</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerFocus: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer4"</span>, <span class="hljs-number">7</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerUnit: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer5"</span>, <span class="hljs-number">3</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerEffects: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer6"</span>, <span class="hljs-number">1</span>, canvasW, canvasH),

    <span class="hljs-comment">/**
     * @type {cwt.LayeredCanvas}
     */</span>
    layerUI: <span class="hljs-keyword">new</span> cwt.LayeredCanvas(<span class="hljs-string">"canvas_layer7"</span>, <span class="hljs-number">1</span>, canvasW, canvasH)
  };
})();

<span class="hljs-comment">/**
 * @class
 */</span>
cwt.Storage = my.Class(<span class="hljs-comment">/** @lends cwt.Storage.prototype */</span> {

  STATIC: <span class="hljs-comment">/** @lends cwt.Storage */</span> {

    <span class="hljs-comment">/**
     * @constant
     */</span>
    IOS7_WEBSQL_BUGFIX_SIZE: <span class="hljs-number">4</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_MAPS: <span class="hljs-string">"MAPS"</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_ASSETS: <span class="hljs-string">"ASSETS"</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_GENERAL: <span class="hljs-string">"GENERAL"</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_MAPS_SIZE: <span class="hljs-number">10</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_ASSETS_SIZE: <span class="hljs-number">40</span>,

    <span class="hljs-comment">/**
     * @constant
     */</span>
    STORAGE_GENERAL_SIZE: <span class="hljs-number">5</span>,

    <span class="hljs-comment">/**
     * Storage for general aw2 like settings.
     *
     * @type {cwt.Storage}
     */</span>
    generalStorage: <span class="hljs-literal">null</span>,

    <span class="hljs-comment">/**
     * Storage for maps.
     *
     * @type {cwt.Storage}
     */</span>
    mapStorage: <span class="hljs-literal">null</span>,

    <span class="hljs-comment">/**
     * Storage for assets aw2 like images and sounds.
     *
     * @type {cwt.Storage}
     */</span>
    assetsStorage: <span class="hljs-literal">null</span>,

    <span class="hljs-comment">/**
     * Initializes the storage system.
     *
     * @param {Function} callback
     */</span>
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">var</span> storage_type = (cwt.ClientFeatures.touch) ? <span class="hljs-string">'webkit-sqlite'</span> : <span class="hljs-string">'indexed-db'</span>;
      <span class="hljs-keyword">var</span> createInstance = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, sizeMb, storage_type, cb)</span> {</span>
        <span class="hljs-keyword">var</span> store = <span class="hljs-keyword">new</span> Lawnchair({
            adaptor: storage_type,
            maxSize: (cwt.ClientFeatures.iosWebSQLFix ?
              cwt.Storage.IOS7_WEBSQL_BUGFIX_SIZE : sizeMb ) * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,
            name: name
          },
          cb
        );
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>creates the creator function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStorage</span><span class="hljs-params">(name, size, prop)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
          createInstance(name, size, storage_type, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(adapter)</span> {</span>
            cwt.Storage[prop] = <span class="hljs-keyword">new</span> cwt.Storage(adapter);
            next();
          });
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>create all storage object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      callAsSequence([
          createStorage(cwt.Storage.STORAGE_MAPS, cwt.Storage.STORAGE_MAPS_SIZE, <span class="hljs-string">"mapStorage"</span>),
          createStorage(cwt.Storage.STORAGE_ASSETS, cwt.Storage.STORAGE_ASSETS_SIZE, <span class="hljs-string">"assetsStorage"</span>),
          createStorage(cwt.Storage.STORAGE_GENERAL, cwt.Storage.STORAGE_GENERAL_SIZE, <span class="hljs-string">"generalStorage"</span>)
        ], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">if</span> (callback) {
            callback();
          }
        }
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>remove initializer function (never called again)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> cwt.Storage.initialize;
    },

    <span class="hljs-comment">/**
     * Nukes the storage objects.
     *
     * @param {Function} callback
     */</span>
    wipeOutAll: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wipeOutStorage</span><span class="hljs-params">(storage)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> {</span>
          storage.clear(next);
        };
      };

      callAsSequence([
        wipeOutStorage(cwt.Storage.generalStorage),
        wipeOutStorage(cwt.Storage.assetsStorage),
        wipeOutStorage(cwt.Storage.mapStorage)
      ], callback );
    }
  },

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(store)</span> {</span>
    <span class="hljs-keyword">this</span>.store = store;
  },

  <span class="hljs-comment">/**
   *
   * @param key
   * @param cb
   */</span>
  get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.get(key, cb);
  },

  <span class="hljs-comment">/**
   *
   * @param key
   * @param cb
   */</span>
  has: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.exists(key, cb);
  },

  <span class="hljs-comment">/**
   *
   * @param key
   * @param cb
   */</span>
  exists: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.exists(key, cb);
  },

  <span class="hljs-comment">/**
   *
   * @param cb
   */</span>
  each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.each(cb);
  },

  <span class="hljs-comment">/**
   * Saves a value with a given key. If the key exists, then the old value
   * will be overwritten. After the save process, the callback cb will be
   * invoked.
   *
   * @param {String} key
   * @param {*} value
   * @param {Function} cb
   */</span>
  set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value, cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.save({ key: key, value: value }, cb, <span class="hljs-comment">/* error function */</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>try a second time when fail at the first time because
on ios the question for more storage invokes an error
 =&gt; we dont want to need to reload then</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.store.save({ key: key, value: value }, cb);
    });
  },

  <span class="hljs-comment">/**
   *
   * @param cb
   */</span>
  keys: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.keys(cb);
  },

  <span class="hljs-comment">/**
   *
   * @param cb
   */</span>
  clear: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.nuke(cb);
  },

  <span class="hljs-comment">/**
   *
   * @param key
   * @param cb
   */</span>
  remove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, cb)</span> {</span>
    <span class="hljs-keyword">this</span>.store.remove(key, cb);
  }
});

cwt.TileVariants = {

  <span class="hljs-comment">/**
   *
   */</span>
  types: {},

  <span class="hljs-comment">/**
   *
   * @param type
   * @param desc
   * @param connection
   */</span>
  registerVariantInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, desc, connection)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(!<span class="hljs-keyword">this</span>.types.hasOwnProperty(type));

    <span class="hljs-keyword">this</span>.types[type] = <span class="hljs-keyword">new</span> cwt.TileVariantInfo(desc, connection);
  },

  <span class="hljs-comment">/**
   *
   */</span>
  updateTileSprites: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> x;
    <span class="hljs-keyword">var</span> y;
    <span class="hljs-keyword">var</span> xe = cwt.Map.width;
    <span class="hljs-keyword">var</span> ye = cwt.Map.height;
    <span class="hljs-keyword">var</span> mapData = cwt.Map.data;

    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xe; x++) {
      <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; ye; y++) {

        <span class="hljs-keyword">var</span> tile = mapData[x][y];</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>tile has variants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.types[tile.type.ID]) {
          tile.variant = <span class="hljs-keyword">this</span>.types[tile.type.ID].getVariant(</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>N</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &gt; <span class="hljs-number">0</span>) ? mapData[x][y - <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>E</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (x &lt; cwt.Map.width - <span class="hljs-number">1</span>) ? mapData[x + <span class="hljs-number">1</span>][y].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>S</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &lt; cwt.Map.height - <span class="hljs-number">1</span>) ? mapData[x][y + <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>W</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (x &gt; <span class="hljs-number">0</span>) ? mapData[x - <span class="hljs-number">1</span>][y].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>NE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &gt; <span class="hljs-number">0</span> &amp;&amp; x &lt; cwt.Map.width - <span class="hljs-number">1</span>) ? mapData[x + <span class="hljs-number">1</span>][y - <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>SE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &lt; cwt.Map.height - <span class="hljs-number">1</span> &amp;&amp; x &lt; cwt.Map.width - <span class="hljs-number">1</span>) ? mapData[x + <span class="hljs-number">1</span>][y + <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>SW</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &lt; cwt.Map.height - <span class="hljs-number">1</span> &amp;&amp; x &gt; <span class="hljs-number">0</span>) ? mapData[x - <span class="hljs-number">1</span>][y + <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>NW</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (y &gt; <span class="hljs-number">0</span> &amp;&amp; x &gt; <span class="hljs-number">0</span>) ? mapData[x - <span class="hljs-number">1</span>][y - <span class="hljs-number">1</span>].type.ID : <span class="hljs-string">""</span>
          );
        } <span class="hljs-keyword">else</span> {
          tile.variant = <span class="hljs-number">0</span>;
        }
      }
    }
  }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>