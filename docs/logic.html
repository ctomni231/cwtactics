<!DOCTYPE html>

<html>
<head>
  <title>logic.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="doc.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ai.html">
                  ai.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="controller.html">
                  controller.js
                </a>
              
                
                <a class="source" href="datatypes.html">
                  datatypes.js
                </a>
              
                
                <a class="source" href="dependencies.html">
                  dependencies.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="input.html">
                  input.js
                </a>
              
                
                <a class="source" href="loading.html">
                  loading.js
                </a>
              
                
                <a class="source" href="logic.html">
                  logic.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="modification.html">
                  modification.js
                </a>
              
                
                <a class="source" href="renderer.html">
                  renderer.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>logic.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

cwt.Config.create(<span class="hljs-string">"weatherMinDays"</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>);
cwt.Config.create(<span class="hljs-string">"weatherRandomDays"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>);
cwt.Config.create(<span class="hljs-string">"round_dayLimit"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">999</span>,<span class="hljs-number">0</span>);
cwt.Config.create(<span class="hljs-string">"noUnitsLeftLoose"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);
cwt.Config.create(<span class="hljs-string">"autoSupplyAtTurnStart"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);
cwt.Config.create(<span class="hljs-string">"unitLimit"</span>,<span class="hljs-number">0</span>,cwt.Player.MAX_UNITS,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>);
cwt.Config.create(<span class="hljs-string">"captureLimit"</span>,<span class="hljs-number">0</span>,cwt.Property.MULTITON_INSTANCES,<span class="hljs-number">0</span>);
cwt.Config.create(<span class="hljs-string">"timer_turnTimeLimit"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">60</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
cwt.Config.create(<span class="hljs-string">"timer_gameTimeLimit"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">99999</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>);
cwt.Config.create(<span class="hljs-string">"fogEnabled"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);
cwt.Config.create(<span class="hljs-string">"daysOfPeace"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">50</span>,<span class="hljs-number">0</span>);
cwt.Config.create(<span class="hljs-string">"co_getStarCost"</span>,<span class="hljs-number">100</span>,<span class="hljs-number">50000</span>,<span class="hljs-number">9000</span>,<span class="hljs-number">100</span>);
cwt.Config.create(<span class="hljs-string">"co_getStarCostIncrease"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">50000</span>,<span class="hljs-number">1800</span>,<span class="hljs-number">100</span>);
cwt.Config.create(<span class="hljs-string">"co_getStarCostIncreaseSteps"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">50</span>,<span class="hljs-number">10</span>);
cwt.Config.create(<span class="hljs-string">"co_enabledCoPower"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Attack = {

  <span class="hljs-comment">/**
   * Signal for units that cannot attack.
   *
   * @constant
   */</span>
  FIRETYPE_NONE: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   * Indirect fire type that can fire from range 2 to x.
   *
   * @constant
   */</span>
  FIRETYPE_INDIRECT: <span class="hljs-number">1</span>,

  <span class="hljs-comment">/**
   * Direct fire type that can fire from range 1 to 1.
   *
   * @constant
   */</span>
  FIRETYPE_DIRECT: <span class="hljs-number">2</span>,

  <span class="hljs-comment">/**
   * Ballistic fire type that can fire from range 1 to x.
   *
   * @constant
   */</span>
  FIRETYPE_BALLISTIC: <span class="hljs-number">3</span>,

  <span class="hljs-comment">/**
   * Calculates the targets of a battle unit. If `data` is given, then
   * the attack targets will be marked in this object.
   *
   * @param {cwt.Unit} unit
   * @param {number} x
   * @param {number} y
   * @param {cwt.SelectionMap=} data
   * @param {boolean=} markTiles
   * @return {boolean}
   */</span>
  calculateTargets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit, x, y, data, markTiles)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.Map.isValidPosition(x, y));

    <span class="hljs-keyword">var</span> markInData = (<span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">"undefined"</span>);
    <span class="hljs-keyword">var</span> teamId = unit.owner.team;
    <span class="hljs-keyword">var</span> attackSheet = unit.type.attack;

    <span class="hljs-keyword">if</span> (markInData) data.setCenter(x, y, cwt.INACTIVE);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>no battle unit ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attackSheet === <span class="hljs-string">"undefined"</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>a unit may does not have ammo but a weapon
that needs ammo to fire</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasMainWeapon(unit) &amp;&amp; !<span class="hljs-keyword">this</span>.hasSecondaryWeapon(unit) &amp;&amp;
      unit.type.ammo &gt; <span class="hljs-number">0</span> &amp;&amp;
      unit.ammo === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> minR = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> maxR = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (unit.type.attack.minrange) {
      minR = unit.type.attack.minrange;
      maxR = unit.type.attack.maxrange;
    }

    <span class="hljs-keyword">var</span> lX;
    <span class="hljs-keyword">var</span> hX;
    <span class="hljs-keyword">var</span> lY = y - maxR;
    <span class="hljs-keyword">var</span> hY = y + maxR;
    <span class="hljs-keyword">if</span> (lY &lt; <span class="hljs-number">0</span>) lY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (hY &gt;= cwt.Map.height) hY = cwt.Map.height - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (; lY &lt;= hY; lY++) {

      <span class="hljs-keyword">var</span> disY = <span class="hljs-built_in">Math</span>.abs(lY - y);
      lX = x - maxR + disY;
      hX = x + maxR - disY;
      <span class="hljs-keyword">if</span> (lX &lt; <span class="hljs-number">0</span>) lX = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (hX &gt;= cwt.Map.width) hX = cwt.Map.width - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (; lX &lt;= hX; lX++) {
        <span class="hljs-keyword">var</span> tile = cwt.Map.data[lX][lY];
        <span class="hljs-keyword">var</span> dis = cwt.Map.getDistance(x, y, lX, lY);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if markTiles is true, then mark all tiles in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (markTiles &amp;&amp; dis &gt;= minR) {
          data.setValueAt(lX, lY, <span class="hljs-number">1</span>);
          <span class="hljs-keyword">continue</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>drop tile when hidden in fog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (tile.visionTurnOwner === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

        <span class="hljs-keyword">if</span> (dis &gt;= minR) {
          <span class="hljs-keyword">var</span> dmg = -<span class="hljs-number">1</span>;

          <span class="hljs-keyword">var</span> tUnit = tile.unit;
          <span class="hljs-keyword">if</span> (tUnit &amp;&amp; tUnit.owner.team !== teamId) {

            dmg = <span class="hljs-keyword">this</span>.getBaseDamageAgainst(unit, tUnit);
            <span class="hljs-keyword">if</span> (dmg &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if mark tile is true, then mark them in the
selection map else return true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (markInData) data.setValueAt(lX, lY, dmg);
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
          }

        }
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },


  <span class="hljs-comment">/**
   * Returns the fire type.
   */</span>
  getFireType: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasMainWeapon(unit) &amp;&amp; !<span class="hljs-keyword">this</span>.hasSecondaryWeapon(unit)) {
      <span class="hljs-keyword">return</span> cwt.Unit.FIRETYPE_NONE;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>main weapon decides fire type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> unit.type.attack.minrange === <span class="hljs-string">"number"</span>) {
      <span class="hljs-keyword">var</span> min = unit.type.attack.minrange;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>min range of 1 means ballistic weapon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (min === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.FIRETYPE_BALLISTIC;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.FIRETYPE_INDIRECT;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.FIRETYPE_DIRECT;
    }
  },

  <span class="hljs-comment">/**
   * Returns `true` if a given unit is an indirect firing
   * unit ( *e.g. artillery* ) else `false`.
   *
   * @return {boolean}
   */</span>
  isIndirect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">return</span> unit.getFireType() === cwt.Attack.FIRETYPE_INDIRECT;
  },

  <span class="hljs-comment">/**
   * Returns `true` if a given unit is an ballistic firing
   * unit ( *e.g. anti-tank-gun* ) else `false`.
   *
   * @return {boolean}
   */</span>
  isBallistic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">return</span> unit.getFireType() === cwt.Attack.FIRETYPE_BALLISTIC;
  },

  <span class="hljs-comment">/**
   * Returns true if the unit type has a main weapon else false.
   */</span>
  hasMainWeapon: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">var</span> attack = unit.type.attack;
    <span class="hljs-keyword">return</span> (attack &amp;&amp; attack.main_wp);
  },

  <span class="hljs-comment">/**
   * Returns true if the unit type has a secondary
   * weapon else false.
   */</span>
  hasSecondaryWeapon: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">var</span> attack = unit.type.attack;
    <span class="hljs-keyword">return</span> (attack &amp;&amp; attack.sec_wp);
  },

  <span class="hljs-comment">/**
   * Returns true if an attacker can use it's main weapon against a
   * defender. The distance won't be checked in case of indirect units.
   */</span>
  canUseMainWeapon: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender)</span> {</span>
    <span class="hljs-keyword">var</span> attack = attacker.type.attack;
    <span class="hljs-keyword">var</span> tType = defender.type.ID;
    <span class="hljs-keyword">var</span> v;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>check_ ammo and main weapon availability against the defender type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ammo &gt; <span class="hljs-number">0</span> &amp;&amp; attack.main_wp) {
      v = attack.main_wp[tType];
      <span class="hljs-keyword">if</span> (v &amp;&amp; v &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  <span class="hljs-comment">/**
   * Returns true if an unit has targets in sight, else false.
   */</span>
  hasTargets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit, x, y, moved)</span> {</span>
    <span class="hljs-keyword">if</span> (moved &amp;&amp; <span class="hljs-keyword">this</span>.isIndirect(unit)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.calculateTargets(unit, x, y);
  },

  <span class="hljs-comment">/**
   * Returns the base damage of an attacker against a defender. If
   * the attacker cannot attack the defender then -1 will be returned.
   * This function recognizes the ammo usage of main weapons. If the
   * attacker cannot attack with his main weapon due low ammo then only
   * the secondary weapon will be checked.
   */</span>
  getBaseDamageAgainst: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, withMainWp)</span> {</span>
    <span class="hljs-keyword">var</span> attack = attacker.type.attack;
    <span class="hljs-keyword">if</span> (!attack) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> tType = defender.type.ID;
    <span class="hljs-keyword">var</span> v;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> withMainWp === <span class="hljs-string">"undefined"</span>) withMainWp = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>check_ main weapon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (withMainWp &amp;&amp; attacker.ammo &gt; <span class="hljs-number">0</span> &amp;&amp; attack.main_wp !== <span class="hljs-literal">undefined</span>) {
      v = attack.main_wp[tType];
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">"undefined"</span>) <span class="hljs-keyword">return</span> v;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>check_ secondary weapon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (attack.sec_wp !== <span class="hljs-literal">undefined</span>) {
      v = attack.sec_wp[tType];
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">"undefined"</span>) <span class="hljs-keyword">return</span> v;
    }

    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  },

  <span class="hljs-comment">/**
   * Returns the battle damage against an other unit.
   */</span>
  getBattleDamageAgainst: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, luck, withMainWp, isCounter)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> isCounter === <span class="hljs-string">"undefined"</span>) isCounter = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> BASE = <span class="hljs-keyword">this</span>.getBaseDamageAgainst(attacker, defender, withMainWp);
    <span class="hljs-keyword">if</span> (BASE === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">var</span> AHP = cwt.Unit.healthToPoints(attacker);
    <span class="hljs-keyword">var</span> LUCK = <span class="hljs-built_in">parseInt</span>((luck / <span class="hljs-number">100</span>) * <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">var</span> ACO = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">if</span> (isCounter) ACO += <span class="hljs-number">0</span>;

    <span class="hljs-keyword">var</span> def = cwt.Map.searchUnit(defender,<span class="hljs-keyword">this</span>.grabUnitTile_,<span class="hljs-literal">null</span>).type.defense;
    <span class="hljs-keyword">var</span> DCO = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">var</span> DHP = cwt.Unit.healthToPoints(defender);
    <span class="hljs-keyword">var</span> DTR = <span class="hljs-built_in">parseInt</span>(def * <span class="hljs-number">100</span> / <span class="hljs-number">100</span>, <span class="hljs-number">10</span>);

    <span class="hljs-keyword">var</span> damage;
    <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode &lt;= cwt.Gameround.GAME_MODE_AW2) {
      damage = BASE * (ACO / <span class="hljs-number">100</span> - (ACO / <span class="hljs-number">100</span> * (DCO - <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>)) * (AHP / <span class="hljs-number">10</span>);
    } <span class="hljs-keyword">else</span> {
      damage = BASE * (ACO / <span class="hljs-number">100</span> * DCO / <span class="hljs-number">100</span>) * (AHP / <span class="hljs-number">10</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(damage, <span class="hljs-number">10</span>);
  },

  <span class="hljs-comment">/**
   * Declines when the attacker does not have targets in range.
   *
   * @param attId
   * @param defId
   * @param attLuckRatio
   * @param defLuckRatio
   */</span>
  attack: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, attLuckRatio, defLuckRatio)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(attacker <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(defender <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(attLuckRatio &gt;= <span class="hljs-number">0</span> &amp;&amp; attLuckRatio &lt;= <span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(defLuckRatio &gt;= <span class="hljs-number">0</span> &amp;&amp; defLuckRatio &lt;= <span class="hljs-number">100</span>);

    <span class="hljs-keyword">var</span> indirectAttack = <span class="hljs-keyword">this</span>.isIndirect(attacker);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>check_ firstCounter:</strong> if first counter is active then the defender
attacks first. In this case swap attacker and defender.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-comment">/*
     if (!indirectAttack &amp;&amp; controller.scriptedValue(defender.owner, "firstCounter", 0) === 1) {
     if (!model.battle_isIndirectUnit(defId)) {
     var tmp_ = defender;
     defender = attacker;
     attacker = tmp_;
     }
     }
     */</span>

    <span class="hljs-keyword">var</span> aSheets = attacker.type;
    <span class="hljs-keyword">var</span> dSheets = defender.type;
    <span class="hljs-keyword">var</span> attOwner = attacker.owner;
    <span class="hljs-keyword">var</span> defOwner = defender.owner;
    <span class="hljs-keyword">var</span> powerAtt = cwt.Unit.healthToPoints(defender);
    <span class="hljs-keyword">var</span> powerCounterAtt = cwt.Unit.healthToPoints(attacker);
    <span class="hljs-keyword">var</span> mainWpAttack = <span class="hljs-keyword">this</span>.canUseMainWeapon(attacker, defender);
    <span class="hljs-keyword">var</span> damage = <span class="hljs-keyword">this</span>.getBattleDamageAgainst(attacker, defender, attLuckRatio, mainWpAttack, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">if</span> (damage !== -<span class="hljs-number">1</span>) {
      defender.takeDamage(damage);
      <span class="hljs-keyword">if</span> (defender.hp &lt;= <span class="hljs-number">0</span>) {
        cwt.Map.searchUnit(defender, <span class="hljs-keyword">this</span>.destroyAfterBattle_, <span class="hljs-literal">null</span>);
      }

      powerAtt -= cwt.Unit.healthToPoints(defender);

      <span class="hljs-keyword">if</span> (mainWpAttack) attacker.ammo--;

      powerAtt = ( <span class="hljs-built_in">parseInt</span>(powerAtt * <span class="hljs-number">0.1</span> * dSheets.cost, <span class="hljs-number">10</span>) );
      cwt.CO.modifyStarPower(attOwner, <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">0.5</span> * powerAtt, <span class="hljs-number">10</span>));
      cwt.CO.modifyStarPower(defOwner, powerAtt);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>counter attack when defender survives and defender is an indirect attacking unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (defender.hp &gt; <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-keyword">this</span>.isIndirect(defender)) {
      mainWpAttack = <span class="hljs-keyword">this</span>.canUseMainWeapon(defender, attacker);

      damage = <span class="hljs-keyword">this</span>.getBattleDamageAgainst(defender, attacker, defLuckRatio, mainWpAttack, <span class="hljs-literal">true</span>);

      <span class="hljs-keyword">if</span> (damage !== -<span class="hljs-number">1</span>) {
        attacker.takeDamage(damage);
        <span class="hljs-keyword">if</span> (attacker.hp &lt;= <span class="hljs-number">0</span>) {
          cwt.Map.searchUnit(attacker, <span class="hljs-keyword">this</span>.destroyAfterBattle_, <span class="hljs-literal">null</span>);
        }

        powerCounterAtt -= cwt.Unit.healthToPoints(attacker);

        <span class="hljs-keyword">if</span> (mainWpAttack) defender.ammo--;

        powerCounterAtt = ( <span class="hljs-built_in">parseInt</span>(powerCounterAtt * <span class="hljs-number">0.1</span> * aSheets.cost, <span class="hljs-number">10</span>) );
        cwt.CO.modifyStarPower(defOwner, <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">0.5</span> * powerCounterAtt, <span class="hljs-number">10</span>));
        cwt.CO.modifyStarPower(attOwner, powerCounterAtt);
      }
    }
  },

  grabUnitTile_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">return</span> cwt.Map.data[x][y];
  },

  destroyAfterBattle_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    cwt.Lifecycle.destroyUnit(x, y, <span class="hljs-literal">false</span>);
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Capture = {

  <span class="hljs-comment">/**
   * Returns true, when a unit can capture a property,
   * else false.
   */</span>
  canCapture: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">return</span> (unit.type.captures &gt; <span class="hljs-number">0</span>);
  },

  <span class="hljs-comment">/**
   *
   * @param property
   * @return {boolean}
   */</span>
  canBeCaptured: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">return</span> (property.type.capturePoints &gt; <span class="hljs-number">0</span>);
  },

  <span class="hljs-comment">/**
   *
   */</span>
  captureProperty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property,unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit);

    <span class="hljs-keyword">this</span>.points -= cwt.Property.CAPTURE_STEP;
    cwt.ClientEvents.unitCaptures(<span class="hljs-keyword">this</span>,unit);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.points &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.owner = unit.owner;
      <span class="hljs-keyword">this</span>.points = cwt.Property.CAPTURE_POINTS;
      cwt.ClientEvents.propertyCaptured(<span class="hljs-keyword">this</span>,unit);
    }
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.CO = {

  <span class="hljs-comment">/**
   * Power level of normal CO power.
   */</span>
  POWER_LEVEL_COP: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   * Power level of normal super CO power.
   */</span>
  POWER_LEVEL_SCOP: <span class="hljs-number">1</span>,

  <span class="hljs-comment">/**
   * Modifies the power level of a player.
   */</span>
  modifyStarPower: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, value)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);

    player.power += value;
    <span class="hljs-keyword">if</span> (player.power &lt; <span class="hljs-number">0</span>) player.power = <span class="hljs-number">0</span>;
  },

  <span class="hljs-comment">/**
   * Decline activate power action on game modes that aren't AW1-3.
   * Decline activate power action when a player cannot activate the base cop level.
   * Returns `true`when a given player can activate a power level.
   *
   * @param player
   * @param powerType
   * @return {boolean}
   */</span>
  canActivatePower: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player,powerType)</span> {</span>
    <span class="hljs-keyword">if</span> (cwt.Config.getValue(<span class="hljs-string">"co_enabledCoPower"</span>) === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(powerType &gt;= cwt.INACTIVE &amp;&amp; powerType &lt;= <span class="hljs-keyword">this</span>.POWER_LEVEL_SCOP);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>co must be available and current power must be inactive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (player.coA === <span class="hljs-literal">null</span> || player.activePower !== cwt.INACTIVE) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> stars;
    <span class="hljs-keyword">switch</span> (powerType) {

      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.POWER_LEVEL_COP:
        stars = player.coA.coStars;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.POWER_LEVEL_SCOP:
        <span class="hljs-keyword">if</span> (cwt.Gameround.gameMode &lt; cwt.Gameround.GAME_MODE_AW2) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        stars = player.coA.scoStars;
        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-keyword">return</span> (player.power &gt;= (<span class="hljs-keyword">this</span>.getStarCost(player) * stars));
  },

  <span class="hljs-comment">/**
   * Activates the CO power of a player.
   *
   * @param {cwt.Player} player
   * @param level
   */</span>
  activatePower: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, level)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(level === cwt.CO.POWER_LEVEL_COP || level === cwt.CO.POWER_LEVEL_SCOP);

    player.power = <span class="hljs-number">0</span>;
    player.activePower = level;
    player.powerUsed++;
  },

  <span class="hljs-comment">/**
   * Deactivates the CO power of a player.
   *
   * @param {cwt.Player} player
   */</span>
  deactivatePower: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);

    player.activePower = cwt.INACTIVE;
  },

  <span class="hljs-comment">/**
   * Returns the cost for one CO star for a given player.
   *
   * @param {cwt.Player} player
   */</span>
  getStarCost: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);

    <span class="hljs-keyword">var</span> cost = cwt.Config.getValue(<span class="hljs-string">"co_getStarCost"</span>);
    <span class="hljs-keyword">var</span> used = player.powerUsed;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if usage counter is greater than max usage counter then use
only the maximum increase counter for calculation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> maxUsed = cwt.Config.getValue(<span class="hljs-string">"co_getStarCostIncreaseSteps"</span>);
    <span class="hljs-keyword">if</span> (used &gt; maxUsed) used = maxUsed;

    cost += used * cwt.Config.getValue(<span class="hljs-string">"co_getStarCostIncrease"</span>);

    <span class="hljs-keyword">return</span> cost;
  },

  <span class="hljs-comment">/**
   * Sets the main CO of a player.
   *
   * @param {cwt.Player} player
   * @param type
   */</span>
  setMainCo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, type)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player <span class="hljs-keyword">instanceof</span> cwt.Player);

    <span class="hljs-keyword">if</span> (type === <span class="hljs-literal">null</span>) {
      player.coA = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.CoSheet.isValidSheet(type));

      player.coA = type;
    }
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Explode = {

  <span class="hljs-comment">/**
   * @private
   * @event
   */</span>
  $defineUnitSchema: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sheet)</span> {</span>
    sheet.properties.suicide = {
      type: <span class="hljs-string">'object'</span>,
      properties: {
        damage: { type: <span class="hljs-string">'integer'</span>, minimum: <span class="hljs-number">1</span>, maximum: <span class="hljs-number">9</span> },
        range: { type: <span class="hljs-string">'integer'</span>, minimum: <span class="hljs-number">1</span>, maximum: <span class="hljs-number">5</span> }
      }
    };
  },

  <span class="hljs-comment">/**
   * Returns `true` if a unit id is a suicide unit. A suicide unit
   * has the ability to blow itself up with an impact.
   *
   * @param {cwt.Unit} unit
   */</span>
  canExplode: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">return</span> unit.type.suicide !== <span class="hljs-literal">undefined</span>;
  },

  <span class="hljs-comment">/**
   * Returns the explosion damage of an exploder.
   *
   * @param unit
   * @return {number}
   */</span>
  getExplosionDamage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">return</span> cwt.Unit.pointsToHealth(unit.type.suicide.damage);
  },

  <span class="hljs-comment">/**
   * Returns the explosion range of an exploder.
   *
   * @param unit
   * @return {number}
   */</span>
  getExplosionRange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">return</span> unit.type.suicide.range;
  },

  <span class="hljs-comment">/**
   *
   * @param {number} x
   * @param {number} y
   * @param {number} range (x &gt;= 1)
   * @param {number} damage (x &gt;= 0)
   */</span>
  doExplosion: cwt.doFunction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

    <span class="hljs-comment">/** @inner */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">damageFn</span><span class="hljs-params">(x, y, tile, damage)</span> {</span>
      <span class="hljs-keyword">var</span> unit = tile.unit;
      <span class="hljs-keyword">if</span> (unit) {
        unit.takeDamage(damage, <span class="hljs-number">9</span>);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, range, damage)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.canExplode(cwt.Gameround.map.data[x][y].unit));
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(range &gt;= <span class="hljs-number">1</span>);

      cwt.Lifecycle.destroyUnit(x, y, <span class="hljs-literal">false</span>);
      cwt.Gameround.map.doInRange(x, y, range, damageFn, damage);
    }
  })

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Factory = {

  <span class="hljs-comment">/**
   * Returns `true` when the given factory object (by its `prid`) is
   * a factory, else `false`.
   *
   * @param {cwt.Property} property
   * @return {boolean}
   */</span>
  isFactory: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(property <span class="hljs-keyword">instanceof</span> cwt.Property);

    <span class="hljs-keyword">return</span> (property.type.builds !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>);
  },

  <span class="hljs-comment">/**
   * Returns `true` when the given factory object is a factory
   * and can produce something technically, else `false`.
   *
   * @param {cwt.Property} property
   * @return {boolean}
   */</span>
  canProduce: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(property <span class="hljs-keyword">instanceof</span> cwt.Property);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>check_ manpower</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!property.owner || !property.owner.manpower) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>check_ unit limit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> uLimit = cwt.Config.getValue(<span class="hljs-string">"unitLimit"</span>);
    <span class="hljs-keyword">if</span> (!uLimit) uLimit = <span class="hljs-number">9999999</span>;
    <span class="hljs-keyword">var</span> count = model.unit_countUnits(playerId);
    <span class="hljs-keyword">if</span> (count &gt;= uLimit) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>slots free ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (count &gt;= MAX_UNITS_PER_PLAYER) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  },

  <span class="hljs-comment">/**
   * Constructs a unit for a player. At least one slot
   * must be free to do this.
   *
   * @param {cwt.Property} factory
   * @param {String} type
   */</span>
  buildUnit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(factory, type)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(factory <span class="hljs-keyword">instanceof</span> cwt.Property);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.UnitSheet.isValidSheet(type));

    <span class="hljs-keyword">var</span> sheet = cwt.UnitSheet.sheets[type];

    factory.owner.manpower--;
    factory.owner.gold -= sheet.cost;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(factory.owner.gold &gt;= <span class="hljs-number">0</span>);

    cwt.Map.searchProperty(factory,cwt.Lifecycle.createUnit,cwt.Lifecycle,type);
  },

  <span class="hljs-comment">/**
   * Generates the build menu for a given factory object (by its `prid`).
   *
   * @param {cwt.Property} factory
   * @param {cwt.Menu} menu
   * @param {boolean=} markDisabled
   * @return {boolean}
   */</span>
  generateBuildMenu: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(factory, menu, markDisabled)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(factory <span class="hljs-keyword">instanceof</span> cwt.Property);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(menu <span class="hljs-keyword">instanceof</span> cwt.Menu);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(factory.owner);

    <span class="hljs-keyword">var</span> unitTypes = cwt.UnitSheet.types;
    <span class="hljs-keyword">var</span> bList = factory.type.builds;
    <span class="hljs-keyword">var</span> gold = factory.owner.gold;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = unitTypes.length; i &lt; e; i++) {
      <span class="hljs-keyword">var</span> key = unitTypes[i];
      <span class="hljs-keyword">var</span> type = cwt.UnitSheet.sheets[key];

      <span class="hljs-keyword">if</span> (bList.indexOf(type.movetype) === -<span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Is the tile blocked ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (type.blocked) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">if</span> (type.cost &lt;= gold || markDisabled) {
        menu.addEntry(key, (type.cost &lt;= gold));
      }
    }
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Fog = {

  <span class="hljs-comment">/**
   * Modifies a vision at a given position and player.
   */</span>
  modifyVision_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner, range, value)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>ignore neutral objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (owner.team === cwt.INACTIVE) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (cwt.Config.getValue(<span class="hljs-string">"fogEnabled"</span>) !== <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> clientVisible = owner.clientVisible;
    <span class="hljs-keyword">var</span> turnOwnerVisible = owner.turnOwnerVisible;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>no active player owns this vision</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!clientVisible &amp;&amp; !turnOwnerVisible) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> map = cwt.Map.data;
    <span class="hljs-keyword">if</span> (range === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (clientVisible)    map[x][y].visionClient += value;
      <span class="hljs-keyword">if</span> (turnOwnerVisible) map[x][y].visionTurnOwner += value;

    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> mW = cwt.Map.width;
      <span class="hljs-keyword">var</span> mH = cwt.Map.height;
      <span class="hljs-keyword">var</span> lX;
      <span class="hljs-keyword">var</span> hX;
      <span class="hljs-keyword">var</span> lY = y - range;
      <span class="hljs-keyword">var</span> hY = y + range;

      <span class="hljs-keyword">if</span> (lY &lt; <span class="hljs-number">0</span>) lY = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (hY &gt;= mH) hY = mH - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (; lY &lt;= hY; lY++) {

        <span class="hljs-keyword">var</span> disY = <span class="hljs-built_in">Math</span>.abs(lY - y);
        lX = x - range + disY;
        hX = x + range - disY;
        <span class="hljs-keyword">if</span> (lX &lt; <span class="hljs-number">0</span>) lX = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (hX &gt;= mW) hX = mW - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (; lX &lt;= hX; lX++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>does the tile block vision ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (map[lX][lY].type.blocksVision &amp;&amp; cwt.Map.getDistance(x, y, lX, lY) &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;

          <span class="hljs-keyword">if</span> (clientVisible)    map[lX][lY].visionClient += value;
          <span class="hljs-keyword">if</span> (turnOwnerVisible) map[lX][lY].visionTurnOwner += value;
        }
      }
    }
  },

  <span class="hljs-comment">/**
   * Completely recalculates the fog aw2.
   */</span>
  fullRecalculation: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> x;
    <span class="hljs-keyword">var</span> y;
    <span class="hljs-keyword">var</span> xe = cwt.Map.width;
    <span class="hljs-keyword">var</span> ye = cwt.Map.height;
    <span class="hljs-keyword">var</span> fogEnabled = (cwt.Config.getValue(<span class="hljs-string">"fogEnabled"</span>) === <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> map = cwt.Map.data;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ol>
<li>reset fog maps</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xe; x++) {
      <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; ye; y++) {

        <span class="hljs-keyword">if</span> (!fogEnabled) {
          map[x][y].visionTurnOwner = <span class="hljs-number">1</span>;
          map[x][y].visionClient = <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
          map[x][y].visionTurnOwner = <span class="hljs-number">0</span>;
          map[x][y].visionClient = <span class="hljs-number">0</span>;
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ol>
<li>add vision-object</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (fogEnabled) {
      <span class="hljs-keyword">var</span> vision;
      <span class="hljs-keyword">var</span> unit;
      <span class="hljs-keyword">var</span> tile;
      <span class="hljs-keyword">var</span> property;

      <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; xe; x++) {
        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; ye; y++) {
          tile = map[x][y];

          unit = tile.unit;
          <span class="hljs-keyword">if</span> (unit !== <span class="hljs-literal">null</span>) {
            vision = unit.type.vision;
            <span class="hljs-keyword">if</span> (vision &lt; <span class="hljs-number">0</span>) vision = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">this</span>.modifyVision_(x, y, unit.owner, vision, <span class="hljs-number">1</span>);
          }

          property = tile.property;
          <span class="hljs-keyword">if</span> (property !== <span class="hljs-literal">null</span> &amp;&amp; property.owner !== <span class="hljs-literal">null</span>) {
            vision = property.type.vision;
            <span class="hljs-keyword">if</span> (vision &lt; <span class="hljs-number">0</span>) vision = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">this</span>.modifyVision_(x, y, property.owner, vision, <span class="hljs-number">1</span>);
          }
        }
      }
    }
  },

  <span class="hljs-comment">/**
   * Removes a vision-object from the fog map.
   */</span>
  removeVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner, range)</span> {</span>
    <span class="hljs-keyword">this</span>.modifyVision_(x, y, owner, range, +<span class="hljs-number">1</span>);
  },

  removeUnitVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner)</span> {</span>
    <span class="hljs-keyword">var</span> unit = cwt.Map.data[x][y].unit;
    <span class="hljs-keyword">if</span> (!owner) owner = unit.owner;

    <span class="hljs-keyword">this</span>.removeVision(x, y, owner, unit.type.vision);
  },

  removePropertyVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner)</span> {</span>
    <span class="hljs-keyword">var</span> prop = cwt.Map.data[x][y].property;
    <span class="hljs-keyword">if</span> (!owner) owner = prop.owner;

    <span class="hljs-keyword">this</span>.removeVision(x, y, owner, prop.type.vision);
  },

  <span class="hljs-comment">/**
   * Adds a vision-object from the fog map.
   */</span>
  addVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner, range)</span> {</span>
    <span class="hljs-keyword">this</span>.modifyVision_(x, y, owner, range, -<span class="hljs-number">1</span>);
  },

  addUnitVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner)</span> {</span>
    <span class="hljs-keyword">var</span> unit = cwt.Map.data[x][y].unit;
    <span class="hljs-keyword">if</span> (!owner) owner = unit.owner;

    <span class="hljs-keyword">this</span>.addVision(x, y, owner, unit.type.vision);
  },

  addPropertyVision: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, owner)</span> {</span>
    <span class="hljs-keyword">var</span> prop = cwt.Map.data[x][y].property;
    <span class="hljs-keyword">if</span> (!owner) owner = prop.owner;

    <span class="hljs-keyword">this</span>.addVision(x, y, owner, prop.type.vision);
  }
};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Laser = {

  <span class="hljs-comment">/**
   * Returns true when the unit is a laser unit, else false.
   *
   * @param {cwt.Unit} unit
   * @return {boolean}
   */</span>
  isLaser: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">return</span> (unit.type.ID === <span class="hljs-string">"LASER_UNIT_INV"</span>);
  },

  <span class="hljs-comment">/**
   * Fires a laser at a given position.
   *
   * @param {number} x
   * @param {number} y
   */</span>
  fireLaser: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">var</span> map = cwt.Map.data;
    <span class="hljs-keyword">var</span> prop = map[x][y].property;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(prop);

    <span class="hljs-keyword">var</span> ox = x;
    <span class="hljs-keyword">var</span> oy = y;
    <span class="hljs-keyword">var</span> origTeam = prop.owner.team;
    <span class="hljs-keyword">var</span> damage = cwt.Unit.pointsToHealth(prop.type.laser.damage);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>check_ all tiles on the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>, xe = cwt.Map.width; x &lt; xe; x++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>, ye = cwt.Map.height; y &lt; ye; y++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>every tile on the cross ( same y or x coordinate ) will be damaged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (ox === x || oy === y) {

          <span class="hljs-keyword">var</span> unit = map[x][y].unit;
          <span class="hljs-keyword">if</span> (unit &amp;&amp; unit.owner.team !== origTeam) {
            unit.takeDamage(damage,<span class="hljs-number">9</span>);
          }
        }
      }
    }
  }

};

<span class="hljs-comment">/**
 * Logic object for the join mechanic.
 *
 * @namespace
 */</span>
cwt.Join = {

  <span class="hljs-comment">/**
   * Declines wish if two units can join each other in the current situation.
   * Transporters cannot join each other when they loaded units.
   *
   * @param {cwt.Unit} source
   * @param {cwt.Unit} target
   */</span>
  canJoin: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(source, target)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(source <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(target <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">if</span> (source.type !== target.type) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>dont increase HP to more then 10</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (target.hp &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>do they have loads?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.Transport.hasLoads(source) || cwt.Transport.hasLoads(target)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   * Joins two units together. If the combined health is greater than the maximum
   * health then the difference will be payed to the owners resource depot.
   *
   * @param {cwt.Unit} source
   * @param {number} x
   * @param {number} y
   */</span>
  join: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(source, x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(source <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">var</span> target = cwt.Map.data[x][y].unit;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(target <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(source.type === target.type);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>hp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    target.heal(cwt.Unit.pointsToHealth(cwt.Unit.healthToPoints(source)), <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>ammo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    target.ammo += source.ammo;
    <span class="hljs-keyword">if</span> (target.ammo &gt; target.type.ammo) target.ammo = target.type.ammo;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>fuel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    target.fuel += source.fuel;
    <span class="hljs-keyword">if</span> (target.fuel &gt; target.type.fuel) target.fuel = target.type.fuel;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>TODO experience points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    cwt.Lifecycle.destroyUnit(x, y, <span class="hljs-literal">true</span>);
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Relationship = {

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_SAME_THING: -<span class="hljs-number">1</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_NONE: <span class="hljs-number">0</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_OWN: <span class="hljs-number">1</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_ALLIED: <span class="hljs-number">2</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_TEAM: <span class="hljs-number">3</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_ENEMY: <span class="hljs-number">4</span>,

  <span class="hljs-comment">/**
   * @constant
   */</span>
  RELATION_NULL: <span class="hljs-number">5</span>,

  CHECK_NORMAL: <span class="hljs-number">0</span>,

  CHECK_UNIT: <span class="hljs-number">1</span>,

  CHECK_PROPERTY: <span class="hljs-number">2</span>,

  <span class="hljs-comment">/**
   *
   * @param {cwt.Position} left
   * @param {cwt.Position} right
   * @param {number?} checkLeft
   * @param {number?} checkRight
   * @return {number}
   */</span>
  getRelationShipTo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(left, right, checkLeft, checkRight)</span> {</span>
    <span class="hljs-keyword">var</span> oL;
    <span class="hljs-keyword">var</span> oR;

    <span class="hljs-keyword">if</span> (checkLeft !== <span class="hljs-keyword">this</span>.CHECK_PROPERTY) oL = left.unit;
    <span class="hljs-keyword">if</span> (checkRight !== <span class="hljs-keyword">this</span>.CHECK_PROPERTY) oR = right.unit;

    <span class="hljs-keyword">if</span> (!oL &amp;&amp; checkLeft !== <span class="hljs-keyword">this</span>.CHECK_UNIT) oL = left.property;
    <span class="hljs-keyword">if</span> (!oR &amp;&amp; checkRight !== <span class="hljs-keyword">this</span>.CHECK_UNIT) oR = right.property;

    <span class="hljs-keyword">if</span> (!oL) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_NULL;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getRelationship(oL, oR);
  },

  <span class="hljs-comment">/**
   * Returns true if there is an unit with a given relationship on a tile
   * at a given position (x,y).
   *
   * @param {*} objectA
   * @param {*} objectB
   * @return {number}
   */</span>
  getRelationship: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(objectA, objectB)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>one object is null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (objectA === <span class="hljs-literal">null</span> || objectB === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_NONE;
    }

    <span class="hljs-keyword">var</span> playerA = <span class="hljs-comment">/** @type {cwt.Player} */</span> (objectA <span class="hljs-keyword">instanceof</span> cwt.Player) ? objectA : objectA.owner;
    <span class="hljs-keyword">var</span> playerB = <span class="hljs-comment">/** @type {cwt.Player} */</span> (objectB <span class="hljs-keyword">instanceof</span> cwt.Player) ? objectB : objectB.owner;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>one player is inactive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (playerA.team === -<span class="hljs-number">1</span> || playerB.team === -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_NONE;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>own</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (playerA === playerB) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_SAME_THING;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>allied or enemy ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (playerA.team === playerB.team) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_ALLIED;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.RELATION_ENEMY;
    }
  },

  <span class="hljs-comment">/**
   * Returns true if there is an unit with a given relationship in
   * one of the neighbour tiles at a given position (x,y).
   *
   * @example
   *       x
   *     x o x
   *       x
   */</span>
  getRelationshipUnitNeighbours: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, x, y, mode)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.Map.isValidPosition(x, y));

    <span class="hljs-keyword">var</span> unit;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>WEST</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
      unit = cwt.Map.data[x - <span class="hljs-number">1</span>][y].unit;
      <span class="hljs-keyword">if</span> (unit &amp;&amp; <span class="hljs-keyword">this</span>.getRelationship(player, unit.owner) === mode) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>NORTH</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) {
      unit = cwt.Map.data[x][y - <span class="hljs-number">1</span>].unit;
      <span class="hljs-keyword">if</span> (unit &amp;&amp; <span class="hljs-keyword">this</span>.getRelationship(player, unit.owner) === mode) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>EAST</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (x &lt; cwt.Map.width - <span class="hljs-number">1</span>) {
      unit = cwt.Map.data[x + <span class="hljs-number">1</span>][y].unit;
      <span class="hljs-keyword">if</span> (unit &amp;&amp; <span class="hljs-keyword">this</span>.getRelationship(player, unit.owner) === mode) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>SOUTH</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (y &lt; cwt.Map.height - <span class="hljs-number">1</span>) {
      unit = cwt.Map.data[x][y + <span class="hljs-number">1</span>].unit;
      <span class="hljs-keyword">if</span> (unit &amp;&amp; <span class="hljs-keyword">this</span>.getRelationship(player, unit.owner) === mode) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

};

<span class="hljs-comment">/**
 * Logic for the rocket silo mechanic.
 *
 * @namespace
 */</span>
cwt.Silo = {

  <span class="hljs-comment">/**
   * Returns true if a property id is a rocket silo. A rocket silo
   * has the ability to fire a rocket to a position with an impact.
   *
   * @param property
   * @return {boolean}
   */</span>
  isRocketSilo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(property <span class="hljs-keyword">instanceof</span> cwt.Property);

    <span class="hljs-keyword">if</span> (!property.type.rocketsilo) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   *
   * @param property
   * @param unit
   * @return {boolean}
   */</span>
  canBeFiredBy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isRocketSilo(property));

    <span class="hljs-keyword">if</span> (property.type.rocketsilo.fireable.indexOf(unit.type.ID) === -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   * Returns true if a property id is a rocket silo. A rocket silo
   * has the ability to fire a rocket to a position with an impact.
   *
   * @param property
   * @param unit
   * @return {boolean}
   */</span>
  canBeFired: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.type.rocketsilo.fireable.indexOf(unit.type.ID) === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   *
   * @param property
   * @param x
   * @param y
   * @return {boolean}
   */</span>
  canBeFiredTo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(property <span class="hljs-keyword">instanceof</span> cwt.Property);

    <span class="hljs-keyword">if</span> (!cwt.Map.isValidPosition(x, y)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  <span class="hljs-comment">/**
   * Fires a rocket to a given position (x,y) and inflicts damage to
   * all units in a range around the position.
   *
   * @param x
   * @param y
   * @param tx
   * @param ty
   * @param owner
   */</span>
  fireSilo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, tx, ty, owner)</span> {</span>
    <span class="hljs-keyword">var</span> silo = cwt.Map.data[x][y].property;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(silo);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isRocketSilo(silo));

    <span class="hljs-keyword">var</span> type = silo.type;
    <span class="hljs-keyword">var</span> targetType = cwt.PropertySheet.sheets[type.changeTo];

    cwt.ClientEvents.propertyTypeChanged(silo,silo.type,targetType);
    silo.type = targetType;

    <span class="hljs-keyword">var</span> damage = cwt.Unit.pointsToHealth(type.rocketsilo.damage);
    <span class="hljs-keyword">var</span> range = type.rocketsilo.range;

    cwt.Map.doInRange(tx, ty, range, <span class="hljs-keyword">this</span>.exploderDamage_, damage);
  },

  <span class="hljs-comment">/**
   *
   * @param {number} x
   * @param {number} y
   * @param {number} damage (x &gt;= 0)
   * @private
   */</span>
  exploderDamage_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, tile, damage)</span> {</span>
    <span class="hljs-keyword">var</span> unit = tile.unit;
    <span class="hljs-keyword">if</span> (unit) {
      unit.takeDamage(damage, <span class="hljs-number">9</span>);
    }
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Supply = {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong>isSupplier(cwt.Unit): bool</strong></p>
<p>Returns true if a given unit id represents a supplier unit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isSupplier: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">return</span> unit.type.supply;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong>canSupplyTile(cwt.Unit, num, num): bool</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  canSupplyTile: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(supplier, x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isSupplier(supplier));

    <span class="hljs-keyword">if</span> (!cwt.Map.isValidPosition(x, y)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> (cwt.Map.data[x][y].unit !== <span class="hljs-literal">null</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p><strong>hasSupplyTargetsNearby(num, num): bool</strong></p>
<p>Returns true if a given unit id has possible supply targets nearby.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasSupplyTargetsNearby: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.Map.isValidPosition(x, y));

    <span class="hljs-keyword">var</span> supplier = cwt.Map.data[x][y].unit;
    <span class="hljs-keyword">return</span> (
      <span class="hljs-keyword">this</span>.canSupplyTile(supplier, x + <span class="hljs-number">1</span>, y),
        <span class="hljs-keyword">this</span>.canSupplyTile(supplier, x - <span class="hljs-number">1</span>, y),
        <span class="hljs-keyword">this</span>.canSupplyTile(supplier, x, y + <span class="hljs-number">1</span>),
        <span class="hljs-keyword">this</span>.canSupplyTile(supplier, x, y - <span class="hljs-number">1</span>) );
  },

  resupplyTargetByPos: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">var</span> unit = cwt.Map.data[x][y];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit);

    <span class="hljs-keyword">this</span>.resupplyTarget(unit);
  },

  <span class="hljs-comment">/**
   * Refills the supplies of the unit.
   *
   * @param {cwt.Unit} unit
   */</span>
  resupplyTarget: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    unit.ammo = unit.type.ammo;
    unit.fuel = unit.type.fuel;
  },

  <span class="hljs-comment">/**
   * A supplier supplies all surrounding units that can be supplied by the supplier.
   *
   * @param x
   * @param y
   */</span>
  supplyNeighbours: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.Map.isValidPosition(x, y));

    <span class="hljs-keyword">var</span> supplyUnit = cwt.Map.data[x][y].property;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isSupplier(supplyUnit));

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canSupplyTile(supplyUnit, x + <span class="hljs-number">1</span>, y)) <span class="hljs-keyword">this</span>.resupplyTargetByPos(x + <span class="hljs-number">1</span>, y);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canSupplyTile(supplyUnit, x - <span class="hljs-number">1</span>, y)) <span class="hljs-keyword">this</span>.resupplyTargetByPos(x - <span class="hljs-number">1</span>, y);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canSupplyTile(supplyUnit, x, y + <span class="hljs-number">1</span>)) <span class="hljs-keyword">this</span>.resupplyTargetByPos(x, y + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canSupplyTile(supplyUnit, x, y - <span class="hljs-number">1</span>)) <span class="hljs-keyword">this</span>.resupplyTargetByPos(x, y - <span class="hljs-number">1</span>);
  },

  <span class="hljs-comment">/**
   * Drains fuel.
   *
   * @param {cwt.Unit} unit
   * @return {boolean}
   */</span>
  drainFuel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">var</span> v = unit.type.dailyFuelDrain;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">"number"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>hidden units may drain more fuel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hidden &amp;&amp; <span class="hljs-keyword">this</span>.type.dailyFuelDrainHidden) {
        v = <span class="hljs-keyword">this</span>.type.dailyFuelDrainHidden;
      }

      <span class="hljs-keyword">this</span>.fuel -= v;
    }
  },

  <span class="hljs-comment">/**
   *
   * @param property
   */</span>
  raiseFunds: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> property.type.funds !== <span class="hljs-string">"number"</span>) <span class="hljs-keyword">return</span>;
    property.owner.gold += property.type.funds;

    cwt.ClientEvents.goldChange(property.owner, property.type.funds);
  },

  canPropertyHeal: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">var</span> tile = cwt.Map.data[x][y];
    <span class="hljs-keyword">var</span> prop = tile.property;
    <span class="hljs-keyword">var</span> unit = tile.unit;
    <span class="hljs-keyword">if</span> (prop &amp;&amp; unit) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> prop.type.repairs[unit.movetype.ID] === <span class="hljs-string">"number"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  propertyHeal: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.canPropertyHeal(x, y));

    <span class="hljs-keyword">var</span> tile = cwt.Map.data[x][y];
    <span class="hljs-keyword">var</span> prop = tile.property;
    <span class="hljs-keyword">var</span> unit = tile.unit;

    unit.heal( prop.type.repairs[unit.movetype.ID], <span class="hljs-literal">true</span> );
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Team = {

  <span class="hljs-comment">/**
   * Different available money transfer steps.
   */</span>
  MONEY_TRANSFER_STEPS: [
    <span class="hljs-number">1000</span>,
    <span class="hljs-number">2500</span>,
    <span class="hljs-number">5000</span>,
    <span class="hljs-number">10000</span>,
    <span class="hljs-number">25000</span>,
    <span class="hljs-number">50000</span>
  ],

  <span class="hljs-comment">/**
   * Returns `true` when a player can transfer money to a tile owner.
   */</span>
  canTransferMoney: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, x, y)</span> {</span>
    <span class="hljs-keyword">if</span> (player.gold &lt; <span class="hljs-keyword">this</span>.MONEY_TRANSFER_STEPS[<span class="hljs-number">0</span>]) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>only transfer money on headquarters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> property = cwt.Map.data[x][y].property;
    <span class="hljs-keyword">if</span> (!property || !property.type.looseAfterCaptured || property.owner === player) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   * Returns `true` when a player can transfer money
   * to a tile owner.
   *
   * @param player
   * @param menu
   */</span>
  getTransferMoneyTargets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, menu)</span> {</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = <span class="hljs-keyword">this</span>.MONEY_TRANSFER_STEPS.length; i &lt; e; i++) {
      <span class="hljs-keyword">if</span> (player.gold &gt;= <span class="hljs-keyword">this</span>.MONEY_TRANSFER_STEPS[i]) {
        menu.addEntry(<span class="hljs-keyword">this</span>.MONEY_TRANSFER_STEPS[i]);
      }
    }
  },

  <span class="hljs-comment">/**
   * Transfers money from one player to another player.
   *
   * @param playerA
   * @param playerB
   * @param money
   */</span>
  transferMoney: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(playerA, playerB, money)</span> {</span>
    playerA.gold -= money;
    playerB.gold += money;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>the amount of gold cannot be lower 0 after the transfer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.assert(playerA.gold &gt;= <span class="hljs-number">0</span>);

    cwt.ClientEvents.goldChange(playerA, -money, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    cwt.ClientEvents.goldChange(playerB, money, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  },

  <span class="hljs-comment">/**
   *
   */</span>
  canTransferUnit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.Unit);

    <span class="hljs-keyword">if</span> (cwt.Transport.hasLoads(unit)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  <span class="hljs-comment">/**
   *
   */</span>
  getUnitTransferTargets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, menu)</span> {</span>
    <span class="hljs-keyword">var</span> origI = player.id;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">if</span> (i === origI) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">var</span> player = cwt.Player.getInstance(i, <span class="hljs-literal">true</span>);
      <span class="hljs-keyword">if</span> (player &amp;&amp; player.team !== cwt.INACTIVE) {
        menu.addEntry(i, <span class="hljs-literal">true</span>);
      }
    }
  },

  <span class="hljs-comment">/**
   *
   * @param unit
   * @param player
   */</span>
  transferUnitToPlayer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit, player)</span> {</span>
    <span class="hljs-keyword">var</span> origPlayer = unit.owner;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(player.numberOfUnits &lt; cwt.Player.MAX_UNITS);

    origPlayer.numberOfUnits--;
    unit.owner = player;
    player.numberOfUnits++;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>remove vision when unit transfers to an enemy team</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (origPlayer.team !== player.team) {
      cwt.Map.searchUnit(unit, <span class="hljs-keyword">this</span>.changeVision_, <span class="hljs-literal">null</span>, origPlayer);
    }
  },

  <span class="hljs-comment">/**
   *
   */</span>
  canTransferProperty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property)</span> {</span>
    <span class="hljs-keyword">return</span> (property.type.notTransferable !== <span class="hljs-literal">true</span>);
  },

  <span class="hljs-comment">/**
   *
   */</span>
  getPropertyTransferTargets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player, menu)</span> {</span>
    <span class="hljs-keyword">var</span> origI = player.id;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">if</span> (i === origI) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">var</span> player = cwt.Player.getInstance(i, <span class="hljs-literal">true</span>);
      <span class="hljs-keyword">if</span> (player &amp;&amp; player.team !== cwt.INACTIVE) {
        menu.addEntry(i, <span class="hljs-literal">true</span>);
      }
    }
  },

  <span class="hljs-comment">/**
   *
   */</span>
  transferPropertyToPlayer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, player)</span> {</span>
    <span class="hljs-keyword">var</span> origPlayer = property.owner;
    property.owner = player;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>remove vision when unit transfers to an enemy team</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (origPlayer.team !== player.team) {
      cwt.Map.searchProperty(property, <span class="hljs-keyword">this</span>.changeVision_, <span class="hljs-literal">null</span>, origPlayer);
    }
  },

  <span class="hljs-comment">/**
   *
   * @param x
   * @param y
   * @param object
   * @param oldOwner
   * @private
   */</span>
  changeVision_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, object, oldOwner)</span> {</span>
    <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> cwt.Unit) {
      cwt.Fog.removeUnitVision(x, y, oldOwner);
      cwt.Fog.addUnitVision(x, y, object.owner);
    } <span class="hljs-keyword">else</span> {
      cwt.Fog.removePropertyVision(x, y, oldOwner);
      cwt.Fog.addPropertyVision(x, y, object.owner);
    }
  }
};

<span class="hljs-comment">/*
 model.event_on("transferMoney_invoked",function(){
 controller.updateSimpleTileInformation();
 });

 model.event_on("transferUnit_invoked",function( suid ){
 var unit = model.unit_data[suid];
 var x = -unit.x;
 var y = -unit.y;

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>CHECK NEW UNIT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> controller.updateUnitStatus( model.unit_extractId( model.unit_posData[x][y] ) );
 });

 */

/**
 * Logic object for the transport mechanic.
 *
 * @namespace
 */
cwt.Transport = {

  /**
   * Returns true if the unit with id tid is a traensporter, else false.
   *
   * @param {cwt.Unit} unit
   */
  isTransportUnit: function (unit) {
    if (this.DEBUG) cwt.assert(unit instanceof cwt.Unit);

    return (typeof unit.type.maxloads === "number");
  },

  /**
   * Has a transporter unit with id tid loaded units? Returns true
   * if yes, else false.
   *
   * @param {cwt.Unit} unit
   */
  hasLoads: function (unit) {
    if (this.DEBUG) cwt.assert(unit instanceof cwt.Unit);

    for (var i = 0, e = cwt.Unit.MULTITON_INSTANCES; i &lt; e; i++) {
      var cUnit = cwt.Unit.getInstance(i,true);
      if (cUnit &amp;&amp; unit.loadedIn === cUnit) return true;
    }

    return false;
  },

  /**
   * Returns true if a transporter with id tid can load the unit with the id lid.
   * This function also calculates the resulting weight if the transporter would
   * load the unit. If the calculated weight is greater than the maximum loadable
   * weight false will be returned.
   *
   * @param {cwt.Unit} transporter
   * @param {cwt.Unit} load
   */
  canLoadUnit: function (transporter, load) {
    if (this.DEBUG) cwt.assert(transporter instanceof cwt.Unit);
    if (this.DEBUG) cwt.assert(load instanceof cwt.Unit);
    if (this.DEBUG) cwt.assert(load !== transporter);
    if (this.DEBUG) cwt.assert(this.isTransportUnit(transporter));
    if (this.DEBUG) cwt.assert(load.loadedIn !== transporter);

    return (transporter.type.canload.indexOf(load.type.movetype) !== -1);
  },

  /**
   * Loads the unit with id lid into a transporter with the id tid.
   *
   * @param {cwt.Unit} transporter
   * @param {cwt.Unit} load
   */
  load: function (transporter, load) {
    if (this.DEBUG) cwt.assert(transporter instanceof cwt.Unit);
    if (this.DEBUG) cwt.assert(load instanceof cwt.Unit);
    if (this.DEBUG) cwt.assert(this.isTransportUnit(transporter));

    load.loadedIn = transporter;
  },

  /**
   * Unloads the unit with id lid from a transporter with the id tid.
   *
   * @param {cwt.Unit} transport
   * @param {number} trsx
   * @param {number} trsy
   * @param {cwt.Unit} load
   * @param {number} tx
   * @param {number} ty
   */
  unload: function (transport, trsx, trsy, load, tx, ty) {
    if (this.DEBUG) cwt.assert(load.loadedIn === transport);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>TODO: remove this later
trapped ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (tx === -<span class="hljs-number">1</span> || ty === -<span class="hljs-number">1</span> || cwt.Map.data[tx][ty].unit) {
      controller.stateMachine.data.breakMultiStep = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>remove transport link</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    load.loadedIn = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>extract mode code id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> moveCode;
    <span class="hljs-keyword">if</span> (tx &lt; trsx) moveCode = cwt.Move.MOVE_CODES_LEFT;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tx &gt; trsx) moveCode = cwt.Move.MOVE_CODES_RIGHT;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ty &lt; trsy) moveCode = cwt.Move.MOVE_CODES_UP;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ty &gt; trsy) moveCode = cwt.Move.MOVE_CODES_DOWN;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>move load out of the transporter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Move.movePathCache.clear();
    cwt.Move.movePathCache.push(moveCode);
    cwt.Move.move(unit, trsx, trsy, cwt.Move.movePathCache, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);

    transport.canAct = <span class="hljs-literal">false</span>;
    load.canAct = <span class="hljs-literal">false</span>;
  },


  <span class="hljs-comment">/**
   * Returns true if a transporter unit can unload one of it's loads at a given position.
   * This functions understands the given pos as possible position for the transporter.
   *
   * @param {cwt.Unit} transporter
   * @param x
   * @param y
   * @return {*}
   */</span>
  canUnloadSomethingAt: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(transporter, x, y)</span> {</span>
    <span class="hljs-keyword">var</span> pid = transporter.owner;
    <span class="hljs-keyword">var</span> unit;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(<span class="hljs-keyword">this</span>.isTransportUnit(transporter));

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Unit.MULTITON_INSTANCES; i &lt;= e; i++) {

      unit = cwt.Unit.getInstance(i,<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">if</span> (unit &amp;&amp; unit.owner !== cwt.INACTIVE &amp;&amp; unit.loadedIn === transporter) {
        <span class="hljs-keyword">var</span> moveType = unit.type.movetype;

        <span class="hljs-keyword">if</span> (cwt.Move.canTypeMoveTo(moveType, x - <span class="hljs-number">1</span>, y)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (cwt.Move.canTypeMoveTo(moveType, x + <span class="hljs-number">1</span>, y)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (cwt.Move.canTypeMoveTo(moveType, x, y - <span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (cwt.Move.canTypeMoveTo(moveType, x, y + <span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

};

<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.Turn = {

  <span class="hljs-comment">/**
   * Ends the turn for the current active turn owner.
   */</span>
  next: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> pid = cwt.Gameround.turnOwner.id;
    <span class="hljs-keyword">var</span> oid = pid;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Try to find next player from the player pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pid++;
    <span class="hljs-keyword">while</span> (pid !== oid) {

      <span class="hljs-keyword">if</span> (pid === cwt.Player.MULTITON_INSTANCES) {
        pid = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Next day</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cwt.Gameround.day++;
        cwt.Gameround.weatherLeftDays--;

        <span class="hljs-keyword">var</span> round_dayLimit = cwt.Config.getValue(<span class="hljs-string">"round_dayLimit"</span>);
        <span class="hljs-keyword">if</span> (round_dayLimit &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.day &gt;= round_dayLimit) {
          cwt.Update.endGameRound();
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Found next player</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (cwt.Player.getInstance(pid).team !== cwt.INACTIVE) <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Try next player</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      pid++;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If the new player id is the same as the old
player id then the game aw2 is corrupted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(pid !== oid);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Do end/start turn logic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.endsTurn_(cwt.Player.getInstance(oid));
    <span class="hljs-keyword">this</span>.startsTurn_(cwt.Player.getInstance(pid));

    cwt.ClientEvents.turnChange();
  },

  <span class="hljs-comment">/**
   *
   * @param {cwt.Player} player
   * @private
   */</span>
  endsTurn_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player)</span> {</span>
  },

  <span class="hljs-comment">/**
   *
   * @param {cwt.Player} player
   * @private
   */</span>
  startsTurn_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(player)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Sets the new turn owner and also the client, if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Gameround.turnOwner = player;
    <span class="hljs-keyword">if</span> (player.clientControlled) {
      cwt.Player.activeClientPlayer = player;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>the active client can see what his and all allied objects can see</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> clTid = cwt.Player.activeClientPlayer.team;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Player.MULTITON_INSTANCES; i &lt; e; i++) {
      <span class="hljs-keyword">var</span> cPlayer = cwt.Player.getInstance(i);

      cPlayer.turnOwnerVisible = <span class="hljs-literal">false</span>;
      cPlayer.clientVisible = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>player isnt registered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (cPlayer.team === cwt.INACTIVE) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">if</span> (cPlayer.team === clTid) cPlayer.clientVisible = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span> (cPlayer.team === player.team) cPlayer.turnOwnerVisible = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">var</span> cUnit, cProp;

    cwt.Fog.fullRecalculation();</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, e = cwt.Property.MULTITON_INSTANCES; i &lt; e; i++) {
      cProp = cwt.Property.getInstance(i, <span class="hljs-literal">true</span>);
      <span class="hljs-keyword">if</span> (!cProp || cProp.owner !== player) <span class="hljs-keyword">continue</span>;

      cwt.Supply.raiseFunds(cProp);
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = cwt.Unit.MULTITON_INSTANCES; i &lt; e; i++) {
      cUnit = <span class="hljs-comment">/** @type {cwt.Unit} */</span> cwt.Unit.getInstance(i, <span class="hljs-literal">true</span>);
      <span class="hljs-keyword">if</span> (!cUnit || cUnit.owner !== player) <span class="hljs-keyword">continue</span>;

      cUnit.canAct = <span class="hljs-literal">true</span>;
      cwt.Supply.drainFuel(cUnit);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> turnStartSupply = (cwt.Config.getValue(<span class="hljs-string">"autoSupplyAtTurnStart"</span>) === <span class="hljs-number">1</span>);

    <span class="hljs-keyword">var</span> map = cwt.Map.data;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>, xe = cwt.Map.width; x &lt; xe; x++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>, ye = cwt.Map.height; y &lt; ye; y++) {
        cUnit = map[x][y].unit;
        <span class="hljs-keyword">if</span> (cUnit &amp;&amp; cUnit.owner === player) {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>supply units</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (turnStartSupply &amp;&amp; cwt.Supply.isSupplier(cUnit)) {
            cwt.supplyNeighbours(x, y);
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>heal by property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (map[x][y].property &amp;&amp; map[x][y].property.owner === player &amp;&amp; cwt.Supply.canPropertyHeal(x, y)) {
            cwt.Supply.propertyHeal(x, y);
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>unit is out of fuel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (cUnit.fuel &lt;= <span class="hljs-number">0</span>) {
            cwt.Lifecycle.destroyUnit(x, y, <span class="hljs-literal">false</span>);
          }
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Do host only actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.Network.isHost()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Generate new weather</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (cwt.Gameround.weatherLeftDays === <span class="hljs-number">0</span>) {
        cwt.Weather.calculateNextWeather();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Do AI-Turn
TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/*
       if (controller.network_isHost() &amp;&amp; !controller.ai_isHuman(pid)) {
       controller.ai_machine.event("tick");
       }
       */</span>
    }
  }

};

<span class="hljs-comment">/**
 * Weather logic module.
 *
 * @namespace
 */</span>
cwt.Weather = {

  <span class="hljs-comment">/**
   * Calculates the next weather and adds the result as timed event to
   * the day events. **Only invokable by the host instance.**
   */</span>
  calculateNextWeather: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>this event is only host invokable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.assert(cwt.Network.isHost());</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Search a random weather if the last weather
was <code>null</code> or the default weather type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> newTp;
    <span class="hljs-keyword">var</span> duration;
    <span class="hljs-keyword">if</span> (cwt.Gameround.weather &amp;&amp; cwt.Gameround.weather.defaultWeather) {

      <span class="hljs-keyword">var</span> list = cwt.WeatherSheet.types;
      newTp = cwt.selectRandomListElement(list, cwt.Gameround.weather);
      duration = <span class="hljs-number">1</span>;

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Take default weather and calculate a random amount of days</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      newTp = cwt.WeatherSheet.defaultWeather;
      duration = cwt.Config.getValue(<span class="hljs-string">"weatherMinDays"</span>) +
        <span class="hljs-built_in">parseInt</span>(cwt.Config.getValue(<span class="hljs-string">"weatherRandomDays"</span>) * <span class="hljs-built_in">Math</span>.random(), <span class="hljs-number">10</span>);
    }

    cwt.Gameround.weatherLeftDays = duration;
    <span class="hljs-keyword">this</span>.changeWeather(newTp); <span class="hljs-comment">// TODO: send message here</span>
  },

  <span class="hljs-comment">/**
   *
   */</span>
  changeWeather: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(weather)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) cwt.assert(cwt.WeatherSheet.isValidSheet(weather));

    cwt.Gameround.weather = weather;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>recalculate fog map for client and turn
owner due possible weather effects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Fog.fullRecalculation();
  }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>